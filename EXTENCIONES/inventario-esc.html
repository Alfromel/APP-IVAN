<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario de Chips</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
    
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        :root {
            --entel-color: #0088CC;
            --tigo-color: #005EB8;
            --viva-color: #78BE20;
            --primary-color: #4a6fa5;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --sidebar-width: 260px;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .app-wrapper {
            min-height: 100vh;
            background: white;
            border-radius: 0;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        /* Sidebar */
        .app-sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%);
            color: white;
            transition: all 0.3s;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-brand {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-brand h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-brand h2 i {
            color: #667eea;
            font-size: 1.8rem;
        }
        
        .sidebar-nav {
            padding: 20px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 25px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            margin: 5px 15px;
            border-radius: 8px;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.2) 0%, transparent 100%);
            color: white;
            border-left-color: #667eea;
        }
        
        .nav-item i {
            font-size: 1.3rem;
            width: 30px;
        }
        
        .nav-badge {
            margin-left: auto;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }
        
        .nav-badge.badge-danger {
            background: rgba(220, 53, 69, 0.8);
        }
        
        /* Header */
        .app-header {
            height: 70px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 0 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }
        
        /* Contenido */
        .app-content {
            flex: 1;
            padding: 25px;
            background: #f8f9fa;
            overflow-y: auto;
        }
        
        /* Tarjetas de estadísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }
        
        .stat-card.entel::before { background: var(--entel-color); }
        .stat-card.tigo::before { background: var(--tigo-color); }
        .stat-card.viva::before { background: var(--viva-color); }
        .stat-card.total::before { background: linear-gradient(90deg, #667eea, #764ba2); }
        
        .stat-number {
            font-size: 2.8rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Tarjetas generales */
        .app-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .app-card-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-card-body {
            padding: 25px;
        }
        
        /* Botones personalizados */
        .btn-custom {
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            border: none;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success-custom {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-warning-custom {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* Badges personalizados */
        .badge-custom {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        .badge-entel { background: var(--entel-color); }
        .badge-tigo { background: var(--tigo-color); }
        .badge-viva { background: var(--viva-color); }
        
        /* Tablas */
        .table-custom {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .table-custom thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
        }
        
        .table-custom tbody tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        /* Filtros */
        .filter-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        /* Chips por vencer */
        .chip-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        
        .chip-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .chip-card.entel { border-left-color: var(--entel-color); }
        .chip-card.tigo { border-left-color: var(--tigo-color); }
        .chip-card.viva { border-left-color: var(--viva-color); }
        
        .chip-card.critico {
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
        }
        
        .chip-card.advertencia {
            border-left-color: var(--warning-color);
            background: linear-gradient(135deg, #fffdf0 0%, #fff 100%);
        }
        
        /* Indicador de días */
        .days-badge {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9rem;
        }
        
        .days-green { background: var(--success-color); }
        .days-yellow { background: var(--warning-color); }
        .days-red { background: var(--danger-color); }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .app-sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                bottom: 0;
                z-index: 1050;
            }
            
            .app-sidebar.show {
                left: 0;
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1040;
                display: none;
            }
            
            .sidebar-overlay.show {
                display: block;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay d-none" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div class="mt-3 text-primary fw-bold">Cargando sistema...</div>
        </div>
    </div>

    <div class="app-wrapper d-flex">
        <!-- Sidebar -->
        <div class="app-sidebar d-flex flex-column">
            <div class="sidebar-brand">
                <h2>
                    <i class="bi bi-sim-fill"></i>
                    <span>Inventario Chips</span>
                </h2>
            </div>
            
            <div class="sidebar-nav flex-grow-1">
                <a href="#" class="nav-item active" data-section="dashboard">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                    <span class="nav-badge" id="sidebarTotalChips">0</span>
                </a>
                <a href="#" class="nav-item" data-section="inventario">
                    <i class="bi bi-grid-3x3-gap-fill"></i>
                    <span>Inventario</span>
                    <span class="nav-badge" id="sidebarInventario">0</span>
                </a>
                <a href="#" class="nav-item" data-section="categorias">
                    <i class="bi bi-folder-fill"></i>
                    <span>Categorías</span>
                    <span class="nav-badge" id="sidebarCategorias">0</span>
                </a>
                <a href="#" class="nav-item" data-section="reportes">
                    <i class="bi bi-graph-up-arrow"></i>
                    <span>Reportes</span>
                </a>
                <a href="#" class="nav-item" data-section="por-vencer">
                    <i class="bi bi-clock-fill"></i>
                    <span>Por Vencer</span>
                    <span class="nav-badge badge-danger" id="sidebarPorVencer">0</span>
                </a>
            </div>
            
            <div class="mt-auto p-3 border-top border-white-10">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="bi bi-person text-white"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="fw-bold">Administrador</div>
                        <small class="text-white-50">Sistema de Chips</small>
                    </div>
                    <button class="btn btn-sm btn-outline-light" id="logoutBtn" title="Cerrar sesión">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Overlay para móviles -->
        <div class="sidebar-overlay"></div>

        <!-- Contenido principal -->
        <div class="app-main flex-grow-1">
            <!-- Header -->
            <header class="app-header">
                <div class="d-flex align-items-center">
                    <button class="btn btn-link d-lg-none me-3 text-dark menu-toggle">
                        <i class="bi bi-list fs-3"></i>
                    </button>
                    <h1 class="header-title" id="currentSectionTitle">Dashboard</h1>
                </div>
                
                <div class="header-actions d-flex gap-2">
                    <button class="btn btn-outline-primary btn-custom" id="refreshDataBtn" title="Actualizar datos">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-primary-custom btn-custom" id="addChipBtn">
                        <i class="bi bi-plus-circle"></i>
                        <span>Agregar Chips</span>
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-success-custom btn-custom dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-download"></i>
                            <span>Exportar</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="exportExcelBtn"><i class="bi bi-file-earmark-excel me-2"></i>Excel</a></li>
                            <li><a class="dropdown-item" href="#" id="exportPDFBtn"><i class="bi bi-file-pdf me-2"></i>PDF</a></li>
                            <li><a class="dropdown-item" href="#" id="exportCSVBtn"><i class="bi bi-file-text me-2"></i>CSV</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <!-- Contenido -->
            <main class="app-content">
                <!-- Dashboard -->
                <section id="dashboardSection" class="fade-in">
                    <!-- Estadísticas principales -->
                    <div class="stats-grid mb-4">
                        <div class="stat-card entel">
                            <div class="stat-number text-primary" id="totalEntel">0</div>
                            <div class="stat-label">Chips ENTEL</div>
                        </div>
                        <div class="stat-card tigo">
                            <div class="stat-number text-info" id="totalTigo">0</div>
                            <div class="stat-label">Chips TIGO</div>
                        </div>
                        <div class="stat-card viva">
                            <div class="stat-number text-success" id="totalViva">0</div>
                            <div class="stat-label">Chips VIVA</div>
                        </div>
                        <div class="stat-card total">
                            <div class="stat-number text-purple" id="totalChips">0</div>
                            <div class="stat-label">Total Chips</div>
                        </div>
                    </div>

                    <!-- Estadísticas secundarias -->
                    <div class="stats-grid mb-4">
                        <div class="stat-card">
                            <div class="stat-number text-success" id="chipsActivos">0</div>
                            <div class="stat-label">Chips Activos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number text-warning" id="chipsPorVencer">0</div>
                            <div class="stat-label">Por Vencer (30 días)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number text-danger" id="chipsVencidos">0</div>
                            <div class="stat-label">Chips Vencidos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number text-purple" id="chipsDesignados">0</div>
                            <div class="stat-label">Chips Designados</div>
                        </div>
                    </div>

                    <!-- Chips por vencer y recientes -->
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="app-card h-100">
                                <div class="app-card-header d-flex justify-content-between align-items-center">
                                    <span>Chips por Vencer (Próximos 30 días)</span>
                                    <button class="btn btn-sm btn-outline-light" onclick="sistema.showSection('por-vencer')">
                                        Ver Todos
                                    </button>
                                </div>
                                <div class="app-card-body">
                                    <div id="chipsPorVencerList">
                                        <!-- Se llena con JavaScript -->
                                    </div>
                                    <div id="noChipsPorVencer" class="text-center text-muted py-4 d-none">
                                        <i class="bi bi-check-circle display-4 text-success"></i>
                                        <p class="mt-2">No hay chips por vencer</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="app-card h-100">
                                <div class="app-card-header">
                                    <span>Chips Recientemente Agregados</span>
                                </div>
                                <div class="app-card-body">
                                    <div id="chipsRecientesList">
                                        <!-- Se llena con JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Inventario -->
                <section id="inventarioSection" class="fade-in d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title">Inventario Completo de Chips</h2>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary-custom btn-custom" id="addCategoryBtn">
                                <i class="bi bi-folder-plus"></i>
                                <span>Nueva Categoría</span>
                            </button>
                            <button class="btn btn-success-custom btn-custom" id="addChipInventarioBtn">
                                <i class="bi bi-plus-circle"></i>
                                <span>Agregar Chips</span>
                            </button>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="filter-card mb-4">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" id="filterOperadora">
                                    <option value="">Todas Operadoras</option>
                                    <option value="ENTEL">ENTEL</option>
                                    <option value="TIGO">TIGO</option>
                                    <option value="VIVA">VIVA</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterEstado">
                                    <option value="">Todos Estados</option>
                                    <option value="ACTIVO">Activos</option>
                                    <option value="VENCIDO">Vencidos</option>
                                    <option value="INACTIVO">Inactivos</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterCategoria">
                                    <option value="">Todas Categorías</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="filterBusqueda" placeholder="Buscar...">
                                    <button class="btn btn-outline-secondary" type="button" id="clearFiltersBtn">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla -->
                    <div class="app-card">
                        <div class="app-card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-custom mb-0" id="inventarioTable">
                                    <thead>
                                        <tr>
                                            <th># Secuencia</th>
                                            <th>Número</th>
                                            <th>Operadora</th>
                                            <th>Categoría</th>
                                            <th>Fecha Nac.</th>
                                            <th>Fecha Venc.</th>
                                            <th>Días Rest.</th>
                                            <th>Estado</th>
                                            <th>Designado a</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventarioTableBody">
                                        <!-- Se llena con JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Categorías -->
                <section id="categoriasSection" class="fade-in d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title">Gestión de Categorías</h2>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success-custom btn-custom" id="exportCategoriesBtn">
                                <i class="bi bi-file-earmark-excel"></i>
                                <span>Exportar</span>
                            </button>
                            <button class="btn btn-primary-custom btn-custom" id="addCategoryMainBtn">
                                <i class="bi bi-folder-plus"></i>
                                <span>Nueva Categoría</span>
                            </button>
                        </div>
                    </div>

                    <div class="app-card">
                        <div class="app-card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-custom mb-0" id="categoriasTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Letra</th>
                                            <th>Operadora</th>
                                            <th>Nombre</th>
                                            <th>Fecha Nac.</th>
                                            <th>Fecha Venc.</th>
                                            <th>Días</th>
                                            <th>Chips</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="categoriasTableBody">
                                        <!-- Se llena con JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Reportes -->
                <section id="reportesSection" class="fade-in d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title">Reportes y Estadísticas</h2>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary-custom btn-custom" id="generateReportBtn">
                                <i class="bi bi-graph-up"></i>
                                <span>Generar Reporte</span>
                            </button>
                            <button class="btn btn-success-custom btn-custom" id="exportReportBtn">
                                <i class="bi bi-download"></i>
                                <span>Exportar</span>
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="app-card h-100">
                                <div class="app-card-header">
                                    Distribución por Operadora
                                </div>
                                <div class="app-card-body">
                                    <canvas id="operadoraChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="app-card h-100">
                                <div class="app-card-header">
                                    Estados de Chips
                                </div>
                                <div class="app-card-body">
                                    <canvas id="estadoChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Por Vencer -->
                <section id="por-vencerSection" class="fade-in d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title">Chips por Vencer</h2>
                        <div class="d-flex gap-2">
                            <button class="btn btn-warning-custom btn-custom" id="exportPorVencerBtn">
                                <i class="bi bi-download"></i>
                                <span>Exportar Lista</span>
                            </button>
                            <button class="btn btn-primary-custom btn-custom" id="sendAlertsBtn">
                                <i class="bi bi-bell"></i>
                                <span>Enviar Alertas</span>
                            </button>
                        </div>
                    </div>

                    <div class="app-card">
                        <div class="app-card-body">
                            <div id="allChipsPorVencer">
                                <!-- Se llena con JavaScript -->
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Modales -->
    <!-- Modal Categorías -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="categoryModalLabel">Nueva Categoría</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ID de Categoría *</label>
                                <input type="text" class="form-control" id="categoria_id" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Letra *</label>
                                <input type="text" class="form-control" id="letra_categoria" maxlength="3" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Operadora *</label>
                                <select class="form-select" id="operadora" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="ENTEL">ENTEL</option>
                                    <option value="TIGO">TIGO</option>
                                    <option value="VIVA">VIVA</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="nombre" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Nacimiento *</label>
                                <input type="date" class="form-control" id="fecha_activacion" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Días para Vencimiento *</label>
                                <input type="number" class="form-control" id="dias_vencimiento" min="1" value="60" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observaciones" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveCategoryBtn">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Chips -->
    <div class="modal fade" id="chipModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="chipModalLabel">Agregar Chips</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="chipForm">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Operadora *</label>
                                <select class="form-select" id="chipOperadora" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="ENTEL">ENTEL</option>
                                    <option value="TIGO">TIGO</option>
                                    <option value="VIVA">VIVA</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Categoría *</label>
                                <select class="form-select" id="chipCategoria" required>
                                    <option value="">Seleccionar categoría</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Números de Chips *</label>
                            <textarea class="form-control" id="chipsNumeros" rows="6" 
                                placeholder="Ingrese números separados por comas, espacios o líneas nuevas. Ejemplo:
78901234
78901235, 78901236
78901237 78901238"></textarea>
                            <div class="form-text">Puede ingresar múltiples números a la vez</div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chipDesignadoCheck">
                                <label class="form-check-label fw-bold">Designar estos chips</label>
                            </div>
                            <div id="chipDesignadoContainer" class="mt-2 d-none">
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="chipDesignadoA" placeholder="Designado a...">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="chipDesignadoObservaciones" placeholder="Observaciones">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveChipBtn">Guardar Chips</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Designar -->
    <div class="modal fade" id="designarModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Designar Chip</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="designarForm">
                        <input type="hidden" id="designarChipId">
                        <div class="mb-3">
                            <label class="form-label">Designar a *</label>
                            <input type="text" class="form-control" id="designarA" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" id="designarObservaciones" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveDesignacionBtn">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // CONFIGURACIÓN SUPABASE CON TUS CREDENCIALES
        const SUPABASE_URL = 'https://vibrbdbpgmgskorvrwmd.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_NO3VQGNqHY2jpgpiTr6dxw_rxbso_dX';

        // Variables globales
        let allChips = [];
        let allCategories = [];
        let chipsPorVencer = [];

        class SistemaInventarioChips {
            constructor() {
                this.init();
            }

            async init() {
                try {
                    this.setupEventListeners();
                    await this.loadAllData();
                    this.updateSidebarCounts();
                } catch (error) {
                    console.error('Error inicializando sistema:', error);
                    this.showAlert('Error', 'Error al inicializar el sistema', 'error');
                }
            }

            setupEventListeners() {
                // Navegación
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showSection(item.dataset.section);
                    });
                });

                // Botones principales
                document.getElementById('refreshDataBtn').addEventListener('click', () => this.refreshData());
                document.getElementById('addChipBtn').addEventListener('click', () => this.showAddChipModal());
                document.getElementById('addChipInventarioBtn').addEventListener('click', () => this.showAddChipModal());
                document.getElementById('addCategoryBtn').addEventListener('click', () => this.showCategoryModal());
                document.getElementById('addCategoryMainBtn').addEventListener('click', () => this.showCategoryModal());
                document.getElementById('sendAlertsBtn').addEventListener('click', () => this.sendAlertsPorVencer());

                // Guardar
                document.getElementById('saveCategoryBtn').addEventListener('click', () => this.saveCategory());
                document.getElementById('saveChipBtn').addEventListener('click', () => this.saveChips());
                document.getElementById('saveDesignacionBtn').addEventListener('click', () => this.saveDesignacion());

                // Exportar
                document.getElementById('exportExcelBtn').addEventListener('click', () => this.exportToExcel());
                document.getElementById('exportPDFBtn').addEventListener('click', () => this.exportToPDF());
                document.getElementById('exportCSVBtn').addEventListener('click', () => this.exportToCSV());
                document.getElementById('exportCategoriesBtn').addEventListener('click', () => this.exportCategories());
                document.getElementById('exportReportBtn').addEventListener('click', () => this.exportReport());
                document.getElementById('exportPorVencerBtn').addEventListener('click', () => this.exportPorVencer());

                // Filtros
                document.getElementById('clearFiltersBtn').addEventListener('click', () => this.clearFilters());
                document.getElementById('filterBusqueda').addEventListener('input', () => this.displayInventarioTable());
                document.getElementById('filterOperadora').addEventListener('change', () => this.displayInventarioTable());
                document.getElementById('filterEstado').addEventListener('change', () => this.displayInventarioTable());
                document.getElementById('filterCategoria').addEventListener('change', () => this.displayInventarioTable());

                // Designación
                document.getElementById('chipDesignadoCheck').addEventListener('change', (e) => {
                    document.getElementById('chipDesignadoContainer').classList.toggle('d-none', !e.target.checked);
                });

                // Preview chips
                document.getElementById('chipOperadora').addEventListener('change', () => this.updateChipCategories());

                // Menu toggle
                document.querySelector('.menu-toggle').addEventListener('click', () => this.toggleSidebar());

                // Logout
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
            }

            async loadAllData() {
                this.showLoading(true);
                try {
                    await Promise.all([
                        this.loadCategories(),
                        this.loadChips()
                    ]);
                    
                    this.updateDashboard();
                    this.updateSidebarCounts();
                    
                    // Cargar datos de la sección actual
                    const currentSection = this.getCurrentSection();
                    if (currentSection === 'inventario') {
                        this.displayInventarioTable();
                    } else if (currentSection === 'categorias') {
                        this.displayCategoriasTable();
                    } else if (currentSection === 'reportes') {
                        this.loadReportsData();
                    } else if (currentSection === 'por-vencer') {
                        this.displayChipsPorVencer();
                    }
                    
                } catch (error) {
                    console.error('Error cargando datos:', error);
                    this.showAlert('Error', 'Error al cargar los datos', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async loadCategories() {
                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/chip_categories?select=*&order=id.desc`,
                        {
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            }
                        }
                    );
                    
                    if (!response.ok) throw new Error('Error cargando categorías');
                    
                    allCategories = await response.json();
                    this.populateCategoryFilters();
                    return allCategories;
                } catch (error) {
                    throw error;
                }
            }

            async loadChips() {
                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/chip_inventory?select=*&order=id.desc`,
                        {
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            }
                        }
                    );
                    
                    if (!response.ok) throw new Error('Error cargando chips');
                    
                    allChips = await response.json();
                    
                    // Calcular días restantes y estado
                    allChips.forEach(chip => {
                        chip.dias_restantes = this.calcularDiasRestantes(chip.fecha_vencimiento);
                        chip.estado_display = this.determinarEstado(chip);
                    });
                    
                    // Chips por vencer
                    chipsPorVencer = allChips.filter(chip => 
                        chip.estado === 'ACTIVO' && 
                        chip.dias_restantes > 0 && 
                        chip.dias_restantes <= 30
                    ).sort((a, b) => a.dias_restantes - b.dias_restantes);
                    
                    return allChips;
                } catch (error) {
                    throw error;
                }
            }

            calcularDiasRestantes(fechaVencimiento) {
                if (!fechaVencimiento) return 0;
                const hoy = new Date();
                const vencimiento = new Date(fechaVencimiento);
                const diffTime = vencimiento - hoy;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }

            determinarEstado(chip) {
                if (chip.estado === 'VENCIDO') return 'VENCIDO';
                const dias = this.calcularDiasRestantes(chip.fecha_vencimiento);
                if (dias <= 0) return 'VENCIDO';
                if (dias <= 7) return 'CRITICO';
                if (dias <= 30) return 'POR_VENCER';
                if (chip.designado_a) return 'DESIGNADO';
                return 'ACTIVO';
            }

            updateDashboard() {
                // Totales por operadora
                const entelCount = allChips.filter(chip => chip.operadora === 'ENTEL').length;
                const tigoCount = allChips.filter(chip => chip.operadora === 'TIGO').length;
                const vivaCount = allChips.filter(chip => chip.operadora === 'VIVA').length;
                
                document.getElementById('totalEntel').textContent = entelCount;
                document.getElementById('totalTigo').textContent = tigoCount;
                document.getElementById('totalViva').textContent = vivaCount;
                document.getElementById('totalChips').textContent = allChips.length;
                
                // Estados
                const activosCount = allChips.filter(chip => chip.estado === 'ACTIVO').length;
                const vencidosCount = allChips.filter(chip => chip.estado === 'VENCIDO').length;
                const designadosCount = allChips.filter(chip => chip.designado_a).length;
                
                document.getElementById('chipsActivos').textContent = activosCount;
                document.getElementById('chipsPorVencer').textContent = chipsPorVencer.length;
                document.getElementById('chipsVencidos').textContent = vencidosCount;
                document.getElementById('chipsDesignados').textContent = designadosCount;
                
                // Actualizar listas
                this.updateChipsPorVencerList();
                this.updateChipsRecientesList();
            }

            updateChipsPorVencerList() {
                const container = document.getElementById('chipsPorVencerList');
                const noChips = document.getElementById('noChipsPorVencer');
                
                if (chipsPorVencer.length === 0) {
                    container.innerHTML = '';
                    noChips.classList.remove('d-none');
                    return;
                }
                
                noChips.classList.add('d-none');
                const chipsToShow = chipsPorVencer.slice(0, 5);
                
                container.innerHTML = chipsToShow.map(chip => {
                    const categoria = allCategories.find(cat => cat.id === chip.categoria_id);
                    const estado = this.determinarEstado(chip);
                    const estadoClass = estado === 'CRITICO' ? 'critico' : 'advertencia';
                    
                    return `
                    <div class="chip-card ${chip.operadora.toLowerCase()} ${estadoClass}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge badge-custom badge-${chip.operadora.toLowerCase()} me-2">
                                        ${chip.operadora}
                                    </span>
                                    <strong class="me-2">${chip.numero_secuencia}</strong>
                                    <span>${chip.numero_chip}</span>
                                </div>
                                <div class="text-muted small">
                                    ${categoria?.nombre || 'Sin categoría'} • 
                                    Vence: ${this.formatDate(chip.fecha_vencimiento)}
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="days-badge ${chip.dias_restantes <= 7 ? 'days-red' : 'days-yellow'} me-3">
                                    ${chip.dias_restantes}d
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="sistema.designarChip(${chip.id})">
                                    <i class="bi bi-person-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            updateChipsRecientesList() {
                const container = document.getElementById('chipsRecientesList');
                const recentChips = allChips.slice(0, 5);
                
                container.innerHTML = recentChips.map(chip => {
                    const categoria = allCategories.find(cat => cat.id === chip.categoria_id);
                    
                    return `
                    <div class="chip-card ${chip.operadora.toLowerCase()}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge badge-custom badge-${chip.operadora.toLowerCase()} me-2">
                                        ${chip.operadora}
                                    </span>
                                    <strong class="me-2">${chip.numero_secuencia}</strong>
                                    <span>${chip.numero_chip}</span>
                                </div>
                                <div class="text-muted small">
                                    ${categoria?.nombre || 'Sin categoría'} • 
                                    ${this.formatDate(chip.created_at)}
                                </div>
                            </div>
                            <span class="badge ${this.getEstadoBadgeClass(chip)}">
                                ${this.determinarEstado(chip)}
                            </span>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            updateSidebarCounts() {
                document.getElementById('sidebarTotalChips').textContent = allChips.length;
                document.getElementById('sidebarInventario').textContent = allChips.length;
                document.getElementById('sidebarCategorias').textContent = allCategories.length;
                document.getElementById('sidebarPorVencer').textContent = chipsPorVencer.length;
            }

            showSection(section) {
                // Ocultar todas las secciones
                document.querySelectorAll('[id$="Section"]').forEach(sec => {
                    sec.classList.add('d-none');
                });
                
                // Mostrar sección seleccionada
                document.getElementById(`${section}Section`).classList.remove('d-none');
                
                // Actualizar título
                const titles = {
                    'dashboard': 'Dashboard',
                    'inventario': 'Inventario',
                    'categorias': 'Categorías',
                    'reportes': 'Reportes',
                    'por-vencer': 'Chips por Vencer'
                };
                
                document.getElementById('currentSectionTitle').textContent = titles[section];
                
                // Actualizar navegación activa
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.section === section) {
                        item.classList.add('active');
                    }
                });
                
                // Cargar datos de la sección
                if (section === 'inventario') {
                    this.displayInventarioTable();
                } else if (section === 'categorias') {
                    this.displayCategoriasTable();
                } else if (section === 'reportes') {
                    this.loadReportsData();
                } else if (section === 'por-vencer') {
                    this.displayChipsPorVencer();
                }
                
                // Cerrar sidebar en móviles
                if (window.innerWidth < 768) {
                    this.toggleSidebar();
                }
            }

            displayInventarioTable() {
                const tbody = document.getElementById('inventarioTableBody');
                const chips = this.applyFiltersToChips();
                
                tbody.innerHTML = chips.map(chip => {
                    const categoria = allCategories.find(cat => cat.id === chip.categoria_id);
                    const estado = this.determinarEstado(chip);
                    const diasColor = chip.dias_restantes <= 0 ? 'text-danger' : 
                                   chip.dias_restantes <= 7 ? 'text-danger' : 
                                   chip.dias_restantes <= 30 ? 'text-warning' : 'text-success';
                    
                    return `
                    <tr>
                        <td><strong>${chip.numero_secuencia}</strong></td>
                        <td>${chip.numero_chip}</td>
                        <td>
                            <span class="badge badge-custom badge-${chip.operadora.toLowerCase()}">
                                ${chip.operadora}
                            </span>
                        </td>
                        <td>${categoria?.nombre || 'N/A'}</td>
                        <td>${this.formatDate(chip.fecha_activacion)}</td>
                        <td>${this.formatDate(chip.fecha_vencimiento)}</td>
                        <td class="fw-bold ${diasColor}">
                            ${chip.dias_restantes > 0 ? chip.dias_restantes + ' días' : 'VENCIDO'}
                        </td>
                        <td>
                            <span class="badge ${this.getEstadoBadgeClass(chip)}">
                                ${estado}
                            </span>
                        </td>
                        <td>${chip.designado_a || '-'}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                ${chip.designado_a ? 
                                    `<button class="btn btn-outline-warning" onclick="sistema.removerDesignacion(${chip.id})" title="Remover designación">
                                        <i class="bi bi-person-dash"></i>
                                    </button>` :
                                    `<button class="btn btn-outline-success" onclick="sistema.designarChip(${chip.id})" title="Designar">
                                        <i class="bi bi-person-plus"></i>
                                    </button>`
                                }
                                <button class="btn btn-outline-primary" onclick="sistema.editChip(${chip.id})" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="sistema.deleteChip(${chip.id})" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    `;
                }).join('');
            }

            displayCategoriasTable() {
                const tbody = document.getElementById('categoriasTableBody');
                
                tbody.innerHTML = allCategories.map(categoria => {
                    const chipsCount = allChips.filter(chip => chip.categoria_id === categoria.id).length;
                    
                    return `
                    <tr>
                        <td><strong>${categoria.categoria_id}</strong></td>
                        <td><span class="badge bg-secondary">${categoria.letra_categoria}</span></td>
                        <td>
                            <span class="badge badge-custom badge-${categoria.operadora.toLowerCase()}">
                                ${categoria.operadora}
                            </span>
                        </td>
                        <td>${categoria.nombre}</td>
                        <td>${this.formatDate(categoria.fecha_activacion)}</td>
                        <td>${this.formatDate(categoria.fecha_vencimiento)}</td>
                        <td>${categoria.dias_vencimiento} días</td>
                        <td>
                            <span class="badge ${chipsCount > 0 ? 'bg-primary' : 'bg-secondary'}">
                                ${chipsCount} chips
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="sistema.editCategory(${categoria.id})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="sistema.deleteCategory(${categoria.id})" ${chipsCount > 0 ? 'disabled' : ''}>
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    `;
                }).join('');
            }

            displayChipsPorVencer() {
                const container = document.getElementById('allChipsPorVencer');
                
                if (chipsPorVencer.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-check-circle display-4 text-success mb-3"></i>
                            <h4>No hay chips por vencer</h4>
                            <p class="text-muted">No hay chips que venzan en los próximos 30 días</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = chipsPorVencer.map(chip => {
                    const categoria = allCategories.find(cat => cat.id === chip.categoria_id);
                    const estado = this.determinarEstado(chip);
                    
                    return `
                    <div class="chip-card ${chip.operadora.toLowerCase()} ${estado === 'CRITICO' ? 'critico' : 'advertencia'} mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="days-badge ${chip.dias_restantes <= 7 ? 'days-red' : 'days-yellow'}">
                                    ${chip.dias_restantes}d
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="fw-bold">${chip.numero_secuencia}</div>
                                <div class="text-muted small">${chip.numero_chip}</div>
                            </div>
                            <div class="col-md-2">
                                <span class="badge badge-custom badge-${chip.operadora.toLowerCase()}">
                                    ${chip.operadora}
                                </span>
                            </div>
                            <div class="col-md-3">
                                <div>${categoria?.nombre || 'Sin categoría'}</div>
                                <div class="text-muted small">
                                    Vence: ${this.formatDate(chip.fecha_vencimiento)}
                                </div>
                            </div>
                            <div class="col-md-3">
                                ${chip.designado_a ? 
                                    `<div class="text-success"><i class="bi bi-person-check"></i> ${chip.designado_a}</div>` :
                                    '<div class="text-muted">Sin designar</div>'
                                }
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            showCategoryModal(categoryId = null) {
                const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
                const form = document.getElementById('categoryForm');
                
                form.reset();
                
                if (categoryId) {
                    // Modo edición
                    const category = allCategories.find(cat => cat.id === categoryId);
                    if (category) {
                        document.getElementById('categoryModalLabel').textContent = 'Editar Categoría';
                        document.getElementById('categoryId').value = category.id;
                        document.getElementById('categoria_id').value = category.categoria_id;
                        document.getElementById('letra_categoria').value = category.letra_categoria;
                        document.getElementById('operadora').value = category.operadora;
                        document.getElementById('nombre').value = category.nombre;
                        document.getElementById('fecha_activacion').value = category.fecha_activacion;
                        document.getElementById('dias_vencimiento').value = category.dias_vencimiento;
                        document.getElementById('observaciones').value = category.observaciones || '';
                    }
                } else {
                    // Modo creación
                    document.getElementById('categoryModalLabel').textContent = 'Nueva Categoría';
                    document.getElementById('categoryId').value = '';
                    document.getElementById('fecha_activacion').value = new Date().toISOString().split('T')[0];
                }
                
                modal.show();
            }

            async saveCategory() {
                const form = document.getElementById('categoryForm');
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }
                
                const categoryId = document.getElementById('categoryId').value;
                const categoria_id = document.getElementById('categoria_id').value.trim();
                const letra_categoria = document.getElementById('letra_categoria').value.trim().toUpperCase();
                const operadora = document.getElementById('operadora').value;
                const nombre = document.getElementById('nombre').value.trim();
                const fecha_activacion = document.getElementById('fecha_activacion').value;
                const dias_vencimiento = parseInt(document.getElementById('dias_vencimiento').value);
                const observaciones = document.getElementById('observaciones').value.trim();
                
                // Calcular fecha de vencimiento
                const fechaActivacion = new Date(fecha_activacion);
                const fechaVencimiento = new Date(fechaActivacion);
                fechaVencimiento.setDate(fechaActivacion.getDate() + dias_vencimiento);
                
                const categoryData = {
                    categoria_id: categoria_id,
                    letra_categoria: letra_categoria,
                    operadora: operadora,
                    nombre: nombre,
                    fecha_activacion: fecha_activacion,
                    fecha_vencimiento: fechaVencimiento.toISOString().split('T')[0],
                    dias_vencimiento: dias_vencimiento,
                    observaciones: observaciones || null
                };
                
                try {
                    let response;
                    
                    if (categoryId) {
                        // Actualizar categoría existente
                        response = await fetch(
                            `${SUPABASE_URL}/rest/v1/chip_categories?id=eq.${categoryId}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                                    'Prefer': 'return=representation'
                                },
                                body: JSON.stringify(categoryData)
                            }
                        );
                    } else {
                        // Crear nueva categoría
                        response = await fetch(
                            `${SUPABASE_URL}/rest/v1/chip_categories`,
                            {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                                    'Prefer': 'return=representation'
                                },
                                body: JSON.stringify(categoryData)
                            }
                        );
                    }
                    
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error);
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
                    await this.loadAllData();
                    this.showAlert('Éxito', 'Categoría guardada correctamente', 'success');
                    
                } catch (error) {
                    console.error('Error guardando categoría:', error);
                    this.showAlert('Error', 'No se pudo guardar la categoría', 'error');
                }
            }

            showAddChipModal() {
                const modal = new bootstrap.Modal(document.getElementById('chipModal'));
                const form = document.getElementById('chipForm');
                
                form.reset();
                document.getElementById('chipModalLabel').textContent = 'Agregar Chips';
                document.getElementById('chipDesignadoContainer').classList.add('d-none');
                document.getElementById('chipDesignadoCheck').checked = false;
                
                this.updateChipCategories();
                
                modal.show();
            }

            updateChipCategories() {
                const operadora = document.getElementById('chipOperadora').value;
                const select = document.getElementById('chipCategoria');
                
                const categoriasFiltradas = operadora ? 
                    allCategories.filter(cat => cat.operadora === operadora) : 
                    allCategories;
                
                select.innerHTML = '<option value="">Seleccionar categoría</option>' +
                    categoriasFiltradas.map(cat => `
                        <option value="${cat.id}">
                            ${cat.categoria_id} - ${cat.nombre} (${cat.letra_categoria})
                        </option>
                    `).join('');
            }

            async saveChips() {
                const form = document.getElementById('chipForm');
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }
                
                const operadora = document.getElementById('chipOperadora').value;
                const categoriaId = document.getElementById('chipCategoria').value;
                const designadoCheck = document.getElementById('chipDesignadoCheck').checked;
                const designadoA = designadoCheck ? document.getElementById('chipDesignadoA').value.trim() : null;
                const designadoObservaciones = designadoCheck ? document.getElementById('chipDesignadoObservaciones').value.trim() : null;
                
                // Obtener números de chips
                const numerosText = document.getElementById('chipsNumeros').value;
                const chipNumbers = this.parseChipNumbers(numerosText);
                
                if (chipNumbers.length === 0) {
                    this.showAlert('Error', 'No hay chips para agregar', 'error');
                    return;
                }
                
                // Obtener información de la categoría
                const categoria = allCategories.find(cat => cat.id == categoriaId);
                if (!categoria) {
                    this.showAlert('Error', 'Categoría no encontrada', 'error');
                    return;
                }
                
                const fechaActivacion = categoria.fecha_activacion;
                const fechaActivacionObj = new Date(fechaActivacion);
                const fechaVencimiento = new Date(fechaActivacionObj);
                fechaVencimiento.setDate(fechaActivacionObj.getDate() + categoria.dias_vencimiento);
                
                // Preparar chips para insertar
                const chipsToInsert = chipNumbers.map(numero_chip => ({
                    categoria_id: parseInt(categoriaId),
                    operadora: operadora,
                    numero_chip: numero_chip,
                    fecha_activacion: fechaActivacion,
                    fecha_uso: fechaActivacion,
                    fecha_vencimiento: fechaVencimiento.toISOString().split('T')[0],
                    designado_a: designadoA,
                    designado_observaciones: designadoObservaciones,
                    estado: 'ACTIVO'
                }));
                
                try {
                    // Insertar en lotes
                    const batchSize = 50;
                    let successfulInserts = 0;
                    
                    for (let i = 0; i < chipsToInsert.length; i += batchSize) {
                        const batch = chipsToInsert.slice(i, i + batchSize);
                        
                        const response = await fetch(
                            `${SUPABASE_URL}/rest/v1/chip_inventory`,
                            {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                                    'Prefer': 'return=minimal'
                                },
                                body: JSON.stringify(batch)
                            }
                        );
                        
                        if (response.ok) {
                            successfulInserts += batch.length;
                        } else {
                            const error = await response.text();
                            console.error('Error insertando lote:', error);
                        }
                    }
                    
                    if (successfulInserts > 0) {
                        bootstrap.Modal.getInstance(document.getElementById('chipModal')).hide();
                        await this.loadAllData();
                        this.showAlert('Éxito', `${successfulInserts} chips agregados correctamente`, 'success');
                    } else {
                        throw new Error('No se pudo insertar ningún chip');
                    }
                    
                } catch (error) {
                    console.error('Error guardando chips:', error);
                    this.showAlert('Error', 'No se pudieron guardar los chips', 'error');
                }
            }

            parseChipNumbers(text) {
                if (!text.trim()) return [];
                
                // Separar por líneas, comas o espacios
                return text.split(/[\n, ]+/)
                    .map(num => num.trim())
                    .filter(num => num.length > 0)
                    .filter((num, index, self) => self.indexOf(num) === index); // Únicos
            }

            populateCategoryFilters() {
                const filterSelect = document.getElementById('filterCategoria');
                filterSelect.innerHTML = '<option value="">Todas Categorías</option>' +
                    allCategories.map(cat => `
                        <option value="${cat.id}">
                            ${cat.categoria_id} - ${cat.operadora} - ${cat.nombre}
                        </option>
                    `).join('');
            }

            designarChip(chipId) {
                const chip = allChips.find(c => c.id === chipId);
                if (!chip) return;
                
                const modal = new bootstrap.Modal(document.getElementById('designarModal'));
                document.getElementById('designarChipId').value = chipId;
                document.getElementById('designarA').value = chip.designado_a || '';
                document.getElementById('designarObservaciones').value = chip.designado_observaciones || '';
                
                modal.show();
            }

            async saveDesignacion() {
                const chipId = document.getElementById('designarChipId').value;
                const designadoA = document.getElementById('designarA').value.trim();
                const observaciones = document.getElementById('designarObservaciones').value.trim();
                
                if (!designadoA) {
                    this.showAlert('Error', 'Por favor ingrese a quién se designa el chip', 'error');
                    return;
                }
                
                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/chip_inventory?id=eq.${chipId}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify({
                                designado_a: designadoA,
                                designado_observaciones: observaciones || null,
                                estado: 'ACTIVO'
                            })
                        }
                    );
                    
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error);
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('designarModal')).hide();
                    await this.loadAllData();
                    this.showAlert('Éxito', 'Chip designado correctamente', 'success');
                    
                } catch (error) {
                    console.error('Error designando chip:', error);
                    this.showAlert('Error', 'No se pudo designar el chip', 'error');
                }
            }

            async removerDesignacion(chipId) {
                const result = await Swal.fire({
                    title: '¿Remover designación?',
                    text: 'Este chip dejará de estar asignado a una persona/departamento',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, remover',
                    cancelButtonText: 'Cancelar'
                });
                
                if (!result.isConfirmed) return;
                
                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/chip_inventory?id=eq.${chipId}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify({
                                designado_a: null,
                                designado_observaciones: null
                            })
                        }
                    );
                    
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error);
                    }
                    
                    await this.loadAllData();
                    this.showAlert('Éxito', 'Designación removida correctamente', 'success');
                    
                } catch (error) {
                    console.error('Error removiendo designación:', error);
                    this.showAlert('Error', 'No se pudo remover la designación', 'error');
                }
            }

            async editChip(chipId) {
                const chip = allChips.find(c => c.id === chipId);
                if (!chip) return;
                
                const result = await Swal.fire({
                    title: 'Editar Chip',
                    html: `
                        <div class="mb-3">
                            <label class="form-label">Número de Chip</label>
                            <input type="text" class="form-control" id="editChipNumber" value="${chip.numero_chip}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="editFechaNacimiento" value="${chip.fecha_activacion}">
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Guardar',
                    cancelButtonText: 'Cancelar',
                    preConfirm: () => {
                        const numero = document.getElementById('editChipNumber').value.trim();
                        const fecha = document.getElementById('editFechaNacimiento').value;
                        
                        if (!numero) {
                            Swal.showValidationMessage('El número de chip es requerido');
                            return false;
                        }
                        
                        if (!fecha) {
                            Swal.showValidationMessage('La fecha de nacimiento es requerida');
                            return false;
                        }
                        
                        return { numero_chip: numero, fecha_activacion: fecha };
                    }
                });
                
                if (result.isConfirmed) {
                    try {
                        const { numero_chip, fecha_activacion } = result.value;
                        
                        // Recalcular fecha de vencimiento
                        const categoria = allCategories.find(cat => cat.id === chip.categoria_id);
                        const fechaNacimiento = new Date(fecha_activacion);
                        const fechaVencimiento = new Date(fechaNacimiento);
                        fechaVencimiento.setDate(fechaNacimiento.getDate() + (categoria?.dias_vencimiento || 60));
                        
                        const response = await fetch(
                            `${SUPABASE_URL}/rest/v1/chip_inventory?id=eq.${chipId}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                                    'Prefer': 'return=minimal'
                                },
                                body: JSON.stringify({
                                    numero_chip: numero_chip,
                                    fecha_activacion: fecha_activacion,
                                    fecha_uso: fecha_activacion,
                                    fecha_vencimiento: fechaVencimiento.toISOString().split('T')[0]
                                })
                            }
                        );
                        
                        if (!response.ok) {
                            const error = await response.text();
                            throw new Error(error);
                        }
                        
                        await this.loadAllData();
                        this.showAlert('Éxito', 'Chip actualizado correctamente', 'success');
                        
                    } catch (error) {
                        console.error('Error editando chip:', error);
                        this.showAlert('Error', 'No se pudo actualizar el chip', 'error');
                    }
                }
            }

            async deleteChip(chipId) {
                const result = await Swal.fire({
                    title: '¿Eliminar chip?',
                    text: 'Esta acción no se puede deshacer',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                });
                
                if (!result.isConfirmed) return;
                
                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/chip_inventory?id=eq.${chipId}`,
                        {
                            method: 'DELETE',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Prefer': 'return=minimal'
                            }
                        }
                    );
                    
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error);
                    }
                    
                    await this.loadAllData();
                    this.showAlert('Éxito', 'Chip eliminado correctamente', 'success');
                    
                } catch (error) {
                    console.error('Error eliminando chip:', error);
                    this.showAlert('Error', 'No se pudo eliminar el chip', 'error');
                }
            }

            async deleteCategory(categoryId) {
                // Verificar si la categoría tiene chips
                const chipsInCategory = allChips.filter(chip => chip.categoria_id === categoryId);
                if (chipsInCategory.length > 0) {
                    this.showAlert('Error', 'No se puede eliminar una categoría que tiene chips asignados', 'error');
                    return;
                }
                
                const result = await Swal.fire({
                    title: '¿Eliminar categoría?',
                    text: 'Esta acción no se puede deshacer',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                });
                
                if (!result.isConfirmed) return;
                
                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/chip_categories?id=eq.${categoryId}`,
                        {
                            method: 'DELETE',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Prefer': 'return=minimal'
                            }
                        }
                    );
                    
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error);
                    }
                    
                    await this.loadAllData();
                    this.showAlert('Éxito', 'Categoría eliminada correctamente', 'success');
                    
                } catch (error) {
                    console.error('Error eliminando categoría:', error);
                    this.showAlert('Error', 'No se pudo eliminar la categoría', 'error');
                }
            }

            applyFiltersToChips() {
                const operadora = document.getElementById('filterOperadora').value;
                const estado = document.getElementById('filterEstado').value;
                const categoria = document.getElementById('filterCategoria').value;
                const busqueda = document.getElementById('filterBusqueda').value.toLowerCase();
                
                return allChips.filter(chip => {
                    // Filtro por operadora
                    if (operadora && chip.operadora !== operadora) return false;
                    
                    // Filtro por estado
                    if (estado) {
                        if (estado === 'VENCIDO' && this.determinarEstado(chip) !== 'VENCIDO') return false;
                        if (estado === 'ACTIVO' && chip.estado !== 'ACTIVO') return false;
                        if (estado === 'INACTIVO' && chip.estado !== 'INACTIVO') return false;
                    }
                    
                    // Filtro por categoría
                    if (categoria && chip.categoria_id != categoria) return false;
                    
                    // Filtro por búsqueda
                    if (busqueda) {
                        const chipNumber = chip.numero_chip.toLowerCase();
                        const sequenceNumber = chip.numero_secuencia ? chip.numero_secuencia.toLowerCase() : '';
                        const designado = chip.designado_a ? chip.designado_a.toLowerCase() : '';
                        
                        if (!chipNumber.includes(busqueda) && 
                            !sequenceNumber.includes(busqueda) && 
                            !designado.includes(busqueda)) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }

            clearFilters() {
                document.getElementById('filterOperadora').value = '';
                document.getElementById('filterEstado').value = '';
                document.getElementById('filterCategoria').value = '';
                document.getElementById('filterBusqueda').value = '';
                this.displayInventarioTable();
            }

            loadReportsData() {
                // Destruir gráficos anteriores si existen
                if (window.operadoraChart) window.operadoraChart.destroy();
                if (window.estadoChart) window.estadoChart.destroy();
                
                // Gráfico de distribución por operadora
                const operadoraCtx = document.getElementById('operadoraChart').getContext('2d');
                const operadoraData = {
                    'ENTEL': allChips.filter(chip => chip.operadora === 'ENTEL').length,
                    'TIGO': allChips.filter(chip => chip.operadora === 'TIGO').length,
                    'VIVA': allChips.filter(chip => chip.operadora === 'VIVA').length
                };
                
                window.operadoraChart = new Chart(operadoraCtx, {
                    type: 'pie',
                    data: {
                        labels: ['ENTEL', 'TIGO', 'VIVA'],
                        datasets: [{
                            data: [operadoraData.ENTEL, operadoraData.TIGO, operadoraData.VIVA],
                            backgroundColor: ['#0088CC', '#005EB8', '#78BE20'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 20
                                }
                            }
                        }
                    }
                });

                // Gráfico de estados
                const estadoCtx = document.getElementById('estadoChart').getContext('2d');
                const estadoData = {
                    'Activos': allChips.filter(chip => chip.estado === 'ACTIVO' && this.determinarEstado(chip) !== 'VENCIDO').length,
                    'Por Vencer': chipsPorVencer.length,
                    'Vencidos': allChips.filter(chip => this.determinarEstado(chip) === 'VENCIDO').length,
                    'Designados': allChips.filter(chip => chip.designado_a).length
                };
                
                window.estadoChart = new Chart(estadoCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Activos', 'Por Vencer', 'Vencidos', 'Designados'],
                        datasets: [{
                            label: 'Cantidad de Chips',
                            data: [estadoData.Activos, estadoData['Por Vencer'], estadoData.Vencidos, estadoData.Designados],
                            backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6f42c1'],
                            borderWidth: 0,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            async exportToExcel() {
                const data = allChips.map(chip => {
                    const categoria = allCategories.find(cat => cat.id === chip.categoria_id);
                    const estado = this.determinarEstado(chip);
                    
                    return {
                        'Número Secuencia': chip.numero_secuencia,
                        'Número Chip': chip.numero_chip,
                        'Operadora': chip.operadora,
                        'Categoría': categoria?.nombre || 'N/A',
                        'Fecha Nacimiento': chip.fecha_activacion,
                        'Fecha Vencimiento': chip.fecha_vencimiento,
                        'Días Restantes': chip.dias_restantes,
                        'Estado': estado,
                        'Designado a': chip.designado_a || '',
                        'Observaciones': chip.designado_observaciones || ''
                    };
                });

                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Inventario");
                
                // Ajustar anchos de columnas
                const wscols = [
                    {wch: 15}, {wch: 15}, {wch: 10}, {wch: 20},
                    {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15},
                    {wch: 25}, {wch: 30}
                ];
                worksheet['!cols'] = wscols;

                XLSX.writeFile(workbook, `inventario_chips_${new Date().toISOString().slice(0,10)}.xlsx`);
                this.showAlert('Éxito', 'Archivo Excel generado', 'success');
            }

            exportToPDF() {
                // Para PDF necesitaríamos jsPDF, pero por simplicidad solo haremos Excel y CSV
                this.showAlert('Info', 'La exportación PDF requiere librerías adicionales. Use Excel o CSV.', 'info');
            }

            exportToCSV() {
                const csvContent = [
                    ['Número Secuencia', 'Número Chip', 'Operadora', 'Categoría', 'Fecha Nacimiento', 'Fecha Vencimiento', 'Días Restantes', 'Estado', 'Designado a'].join(','),
                    ...allChips.map(chip => {
                        const categoria = allCategories.find(cat => cat.id === chip.categoria_id);
                        const estado = this.determinarEstado(chip);
                        
                        return [
                            chip.numero_secuencia,
                            chip.numero_chip,
                            chip.operadora,
                            `"${categoria?.nombre || 'N/A'}"`,
                            chip.fecha_activacion,
                            chip.fecha_vencimiento,
                            chip.dias_restantes,
                            estado,
                            `"${chip.designado_a || ''}"`
                        ].join(',');
                    })
                ].join('\n');

                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `inventario_chips_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
                
                this.showAlert('Éxito', 'Archivo CSV generado', 'success');
            }

            exportCategories() {
                const data = allCategories.map(cat => {
                    const chipsCount = allChips.filter(chip => chip.categoria_id === cat.id).length;
                    
                    return {
                        'ID Categoría': cat.categoria_id,
                        'Letra': cat.letra_categoria,
                        'Operadora': cat.operadora,
                        'Nombre': cat.nombre,
                        'Fecha Nacimiento': cat.fecha_activacion,
                        'Fecha Vencimiento': cat.fecha_vencimiento,
                        'Días Vencimiento': cat.dias_vencimiento,
                        'Chips Asignados': chipsCount,
                        'Observaciones': cat.observaciones || ''
                    };
                });

                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Categorías");
                XLSX.writeFile(workbook, `categorias_chips_${new Date().toISOString().slice(0,10)}.xlsx`);
                
                this.showAlert('Éxito', 'Categorías exportadas a Excel', 'success');
            }

            exportReport() {
                this.exportToExcel();
            }

            exportPorVencer() {
                const data = chipsPorVencer.map(chip => {
                    const categoria = allCategories.find(cat => cat.id === chip.categoria_id);
                    
                    return {
                        'Número Secuencia': chip.numero_secuencia,
                        'Número Chip': chip.numero_chip,
                        'Operadora': chip.operadora,
                        'Categoría': categoria?.nombre || 'N/A',
                        'Fecha Vencimiento': chip.fecha_vencimiento,
                        'Días Restantes': chip.dias_restantes,
                        'Designado a': chip.designado_a || '',
                        'Estado': this.determinarEstado(chip)
                    };
                });

                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Chips por Vencer");
                XLSX.writeFile(workbook, `chips_por_vencer_${new Date().toISOString().slice(0,10)}.xlsx`);
                
                this.showAlert('Éxito', 'Chips por vencer exportados a Excel', 'success');
            }

            async refreshData() {
                const refreshBtn = document.getElementById('refreshDataBtn');
                const originalHtml = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise fs-5 animate-spin"></i>';
                
                try {
                    await this.loadAllData();
                    this.showAlert('Éxito', 'Datos actualizados correctamente', 'success');
                } catch (error) {
                    this.showAlert('Error', 'No se pudieron actualizar los datos', 'error');
                } finally {
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalHtml;
                    }, 1000);
                }
            }

            toggleSidebar() {
                const sidebar = document.querySelector('.app-sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                
                sidebar.classList.toggle('show');
                overlay?.classList.toggle('show');
            }

            logout() {
                Swal.fire({
                    title: '¿Cerrar sesión?',
                    text: 'Será redirigido a la página de inicio',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, cerrar sesión',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.showAlert('Sesión cerrada', 'Ha cerrado sesión correctamente', 'success').then(() => {
                            window.location.reload();
                        });
                    }
                });
            }

            sendAlertsPorVencer() {
                if (chipsPorVencer.length === 0) {
                    this.showAlert('Información', 'No hay chips por vencer para notificar', 'info');
                    return;
                }

                Swal.fire({
                    title: 'Enviar alertas',
                    html: `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Se enviarán notificaciones para ${chipsPorVencer.length} chips por vencer.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mensaje</label>
                            <textarea class="form-control" id="alertMessage" rows="3">Hay ${chipsPorVencer.length} chips por vencer en los próximos 30 días. Por favor revisar el sistema de inventario.</textarea>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Enviar Alertas',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.showAlert('Éxito', 'Alertas enviadas a los administradores del sistema', 'success');
                    }
                });
            }

            editCategory(categoryId) {
                this.showCategoryModal(categoryId);
            }

            getCurrentSection() {
                const sections = ['dashboard', 'inventario', 'categorias', 'reportes', 'por-vencer'];
                for (const section of sections) {
                    if (!document.getElementById(`${section}Section`).classList.contains('d-none')) {
                        return section;
                    }
                }
                return 'dashboard';
            }

            getEstadoBadgeClass(chip) {
                const estado = this.determinarEstado(chip);
                switch(estado) {
                    case 'ACTIVO': return 'bg-success';
                    case 'POR_VENCER': return 'bg-warning';
                    case 'CRITICO': return 'bg-danger';
                    case 'VENCIDO': return 'bg-dark';
                    case 'DESIGNADO': return 'bg-purple';
                    default: return 'bg-secondary';
                }
            }

            formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES');
            }

            showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.toggle('d-none', !show);
            }

            showAlert(title, text, icon) {
                Swal.fire({
                    title: title,
                    text: text,
                    icon: icon,
                    timer: 3000,
                    showConfirmButton: false
                });
            }
        }

        // Inicializar el sistema
        document.addEventListener('DOMContentLoaded', () => {
            window.sistema = new SistemaInventarioChips();
        });
    </script>
</body>
</html>
