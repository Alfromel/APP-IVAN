<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sistema de Recargas</title>
    <style>
        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --secondary: #5856D6;
            --danger: #FF3B30;
            --warning: #FF9500;
            --success: #34C759;
            --dark: #1D1D1F;
            --light: #F5F5F7;
            --gray: #8E8E93;
            --border: #D1D1D6;
            --sidebar-bg: #F8F8F8;
            --card-bg: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: #F2F2F7;
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Estilo más plano */
        .sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding-top: 20px;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--primary);
        }

        .nav-menu {
            padding: 0 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--dark);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            text-align: left;
            width: 100%;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            font-weight: 500;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        /* User Info en sidebar */
        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 14px;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: var(--gray);
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
        }

        .logout-btn:hover {
            background: rgba(255, 59, 48, 0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .actions-bar {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            height: 100%;
        }

        .content-section.active {
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Stats Cards - Más plano */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stat-content h3 {
            font-size: 12px;
            color: var(--gray);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }

        /* Tables - Más plano */
        .table-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .table-tools {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background: var(--light);
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            font-size: 14px;
        }

        tbody tr {
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background: var(--light);
        }

        /* Badges - Más plano */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid transparent;
        }

        .badge-success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border-color: rgba(52, 199, 89, 0.2);
        }

        .badge-warning {
            background: rgba(255, 149, 0, 0.1);
            color: var(--warning);
            border-color: rgba(255, 149, 0, 0.2);
        }

        .badge-danger {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border-color: rgba(255, 59, 48, 0.2);
        }

        .badge-info {
            background: rgba(88, 86, 214, 0.1);
            color: var(--secondary);
            border-color: rgba(88, 86, 214, 0.2);
        }

        /* Buttons - Más plano */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg);
            color: var(--dark);
        }

        .btn:hover {
            background: var(--light);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .btn-danger:hover {
            background: #FF1C1C;
            border-color: #FF1C1C;
        }

        /* Form Controls - Más plano */
        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--card-bg);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        /* Form Card */
        .form-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        /* Search & Filters - Mejorados */
        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--card-bg);
        }

        .search-box i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            pointer-events: none;
        }

        .filters-bar {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-label {
            font-size: 13px;
            color: var(--gray);
            font-weight: 500;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 6px;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .action-btn.edit {
            color: var(--primary);
            border-color: rgba(0, 122, 255, 0.2);
            background: rgba(0, 122, 255, 0.1);
        }

        .action-btn.edit:hover {
            background: rgba(0, 122, 255, 0.15);
        }

        .action-btn.delete {
            color: var(--danger);
            border-color: rgba(255, 59, 48, 0.2);
            background: rgba(255, 59, 48, 0.1);
        }

        .action-btn.delete:hover {
            background: rgba(255, 59, 48, 0.15);
        }

        /* Modal - Más plano */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray);
            padding: 4px;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--light);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Loader */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
        }

        .loader.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications - Más plano */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            display: none;
            border: 1px solid transparent;
        }

        .toast.show {
            display: block;
        }

        .toast.success {
            background: var(--success);
            border-color: rgba(52, 199, 89, 0.3);
        }

        .toast.error {
            background: var(--danger);
            border-color: rgba(255, 59, 48, 0.3);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
        }

        /* Pagination - Más plano */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 6px;
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .page-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn:hover:not(.active) {
            background: var(--light);
        }

        /* Bulk Upload Styles */
        .bulk-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            background: var(--light);
        }

        .format-hint {
            color: var(--gray);
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        /* Dashboard específico */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-mobile-alt"></i> Sistema Recargas</h1>
            </div>
            
            <div class="nav-menu">
                <button class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-chart-bar"></i> Dashboard
                </button>
                <button class="nav-item" onclick="showSection('categorias')">
                    <i class="fas fa-folder"></i> Categorías
                </button>
                <button class="nav-item" onclick="showSection('chips')">
                    <i class="fas fa-sim-card"></i> Chips
                </button>
                <button class="nav-item" onclick="showSection('agregar-chip')">
                    <i class="fas fa-plus-circle"></i> Agregar Chip
                </button>
                <button class="nav-item" onclick="showSection('reportes')">
                    <i class="fas fa-file-alt"></i> Reportes
                </button>
                <button class="nav-item" onclick="showSection('movimientos')">
                    <i class="fas fa-exchange-alt"></i> Movimientos
                </button>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Administrador</div>
                    <div class="user-role">Administrador</div>
                </div>
                <button class="logout-btn" onclick="logout()" title="Cerrar sesión">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <h2 id="sectionTitle">Dashboard</h2>
                <div class="actions-bar">
                    <button class="btn" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="content">
                <!-- Dashboard -->
                <div id="dashboard" class="content-section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Categorías</h3>
                                <div class="stat-number" id="statsCategories">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Chips Activos</h3>
                                <div class="stat-number" id="statsChips">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Recargas Totales</h3>
                                <div class="stat-number" id="statsRecargas">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Reportes Hoy</h3>
                                <div class="stat-number" id="statsReportes">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="table-container">
                            <div class="table-header">
                                <h3>Chips con Bajo Stock</h3>
                            </div>
                            <div class="table-responsive">
                                <table id="lowStockTable">
                                    <thead>
                                        <tr>
                                            <th>Número</th>
                                            <th>Operadora</th>
                                            <th>Categoría</th>
                                            <th>Recargas</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Datos se cargan dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="table-container">
                            <div class="table-header">
                                <h3>Resumen General</h3>
                            </div>
                            <div style="padding: 20px;" id="dashboardSummary">
                                <!-- Los datos se cargan dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categorías -->
                <div id="categorias" class="content-section">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Gestión de Categorías</h3>
                            <div class="table-tools">
                                <div class="search-box">
                                    <input type="text" id="searchCategory" placeholder="Buscar categoría..." onkeyup="filterCategories()">
                                    <i class="fas fa-search"></i>
                                </div>
                                <button class="btn btn-primary" onclick="openAddCategoryModal()">
                                    <i class="fas fa-plus"></i> Nueva
                                </button>
                                <button class="btn" onclick="openBulkChipsModal()">
                                    <i class="fas fa-plus-circle"></i> Masivo
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="categoriesTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Chips</th>
                                        <th>Total Recargas</th>
                                        <th>Fecha Creación</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="categoriesBody">
                                    <!-- Datos se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Chips -->
                <div id="chips" class="content-section">
                    <div class="filters-bar">
                        <div class="filter-group">
                            <span class="filter-label">Operadora:</span>
                            <select id="filterOperadora" class="form-control" style="width: 150px;" onchange="filterChips()">
                                <option value="">Todas</option>
                                <option value="TIGO">TIGO</option>
                                <option value="VIVA">VIVA</option>
                                <option value="ENTEL">ENTEL</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Categoría:</span>
                            <select id="filterCategoria" class="form-control" style="width: 150px;" onchange="filterChips()">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Estado:</span>
                            <select id="filterEstado" class="form-control" style="width: 150px;" onchange="filterChips()">
                                <option value="">Todos</option>
                                <option value="agotado">Agotado</option>
                                <option value="bajo">Bajo Stock</option>
                                <option value="normal">Normal</option>
                                <option value="alto">Alto Stock</option>
                            </select>
                        </div>
                        <div class="search-box">
                            <input type="text" id="searchChip" placeholder="Buscar número..." onkeyup="filterChips()">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-responsive">
                            <table id="chipsTable">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Operadora</th>
                                        <th>Categoría</th>
                                        <th>Recargas</th>
                                        <th>Estado</th>
                                        <th>Última Actualización</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="chipsBody">
                                    <!-- Datos se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Agregar Chip -->
                <div id="agregar-chip" class="content-section">
                    <div class="form-card">
                        <h3 style="margin-bottom: 20px; font-weight: 600;">Agregar Nuevo Chip</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="newChipNumber">Número del Chip *</label>
                                <input type="text" id="newChipNumber" class="form-control" placeholder="Ej: 78765432" maxlength="15">
                            </div>

                            <div class="form-group">
                                <label for="newChipOperadora">Operadora *</label>
                                <select id="newChipOperadora" class="form-control">
                                    <option value="">Seleccionar Operadora</option>
                                    <option value="TIGO">TIGO</option>
                                    <option value="VIVA">VIVA</option>
                                    <option value="ENTEL">ENTEL</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="newChipCategory">Categoría *</label>
                                <select id="newChipCategory" class="form-control">
                                    <option value="">Seleccionar Categoría</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="newChipRecargas">Recargas Iniciales *</label>
                                <input type="number" id="newChipRecargas" class="form-control" value="100" min="0">
                            </div>

                            <div class="form-group full-width">
                                <button class="btn btn-primary" onclick="saveNewChip()" style="padding: 12px 24px;">
                                    <i class="fas fa-save"></i> Guardar Chip
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reportes -->
                <div id="reportes" class="content-section">
                    <div class="filters-bar">
                        <div class="filter-group">
                            <span class="filter-label">Fecha:</span>
                            <input type="date" id="filterDate" class="form-control" style="width: 150px;" onchange="filterReports()">
                        </div>
                        <div class="search-box">
                            <input type="text" id="searchReport" placeholder="Buscar usuario o chip..." onkeyup="filterReports()">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-responsive">
                            <table id="reportsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Usuario</th>
                                        <th>Operadora</th>
                                        <th>Recargas</th>
                                        <th>Chip</th>
                                        <th>Categoría</th>
                                        <th>Fecha</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsBody">
                                    <!-- Datos se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Movimientos -->
                <div id="movimientos" class="content-section">
                    <div class="filters-bar">
                        <div class="filter-group">
                            <span class="filter-label">Tipo:</span>
                            <select id="filterMovimiento" class="form-control" style="width: 150px;" onchange="filterMovements()">
                                <option value="">Todos</option>
                                <option value="AGREGAR">Agregar</option>
                                <option value="RESTAR">Restar</option>
                                <option value="REPORTE">Reporte</option>
                            </select>
                        </div>
                        <div class="search-box">
                            <input type="text" id="searchMovement" placeholder="Buscar chip o usuario..." onkeyup="filterMovements()">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-responsive">
                            <table id="movementsTable">
                                <thead>
                                    <tr>
                                        <th>Fecha/Hora</th>
                                        <th>Chip</th>
                                        <th>Tipo</th>
                                        <th>Anterior</th>
                                        <th>Nuevo</th>
                                        <th>Diferencia</th>
                                        <th>Usuario</th>
                                    </tr>
                                </thead>
                                <tbody id="movementsBody">
                                    <!-- Datos se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Categoría -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nueva Categoría</h3>
                <button class="modal-close" onclick="closeAddCategoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="categoryName">Nombre de la Categoría *</label>
                    <input type="text" id="categoryName" class="form-control" placeholder="Ej: Vendedores, Promotores, etc.">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAddCategoryModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveCategory()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Chip -->
    <div id="editChipModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Chip</h3>
                <button class="modal-close" onclick="closeEditChipModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editChipId">
                <div class="form-group">
                    <label for="editChipNumber">Número</label>
                    <input type="text" id="editChipNumber" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="editChipOperadora">Operadora</label>
                    <input type="text" id="editChipOperadora" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="editChipRecargas">Recargas Disponibles *</label>
                    <input type="number" id="editChipRecargas" class="form-control" min="0">
                </div>
                <div class="form-group">
                    <label for="editChipCategory">Categoría</label>
                    <select id="editChipCategory" class="form-control">
                        <!-- Las categorías se cargan dinámicamente -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeEditChipModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="updateChip()">Actualizar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Carga Masiva de Chips -->
    <div id="bulkChipsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Agregar Chips Masivamente</h3>
                <button class="modal-close" onclick="closeBulkChipsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="bulkCategory">Categoría *</label>
                        <select id="bulkCategory" class="form-control">
                            <option value="">Seleccionar Categoría</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="bulkOperadora">Operadora *</label>
                        <select id="bulkOperadora" class="form-control">
                            <option value="">Seleccionar Operadora</option>
                            <option value="TIGO">TIGO</option>
                            <option value="VIVA">VIVA</option>
                            <option value="ENTEL">ENTEL</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="bulkRecargas">Recargas por Chip *</label>
                        <input type="number" id="bulkRecargas" class="form-control" value="100" min="0">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="bulkChipNumbers">Números de Chip (uno por línea, o separados por comas/espacios) *</label>
                    <textarea id="bulkChipNumbers" class="bulk-textarea" placeholder="Ejemplo:
78765432
68712345
79123456

O también puedes usar comas o espacios:
78765432, 68712345, 79123456"></textarea>
                    <div class="format-hint">
                        <i class="fas fa-info-circle"></i>
                        <span>Separa los números por líneas, comas o espacios. Solo números permitidos.</span>
                    </div>
                </div>

                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="progressText" style="text-align: center; font-size: 13px; color: var(--gray);">0% completado</div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeBulkChipsModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="processBulkUpload()" id="processBtn">
                    <i class="fas fa-plus-circle"></i> Crear Chips
                </button>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div style="font-size: 14px; color: var(--dark); font-weight: 500;">Cargando...</div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast" id="toast"></div>

    <script>
        // CONFIGURACIÓN SUPABASE
        const SUPABASE_URL = 'https://iyowgljzuryeowyceaio.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_xr2MZ4YwV7zslfp9Wzs2WQ_aSfFX_87';
        
        // Variables globales
        let categories = [];
        let chips = [];
        let reports = [];
        let movements = [];
        let currentUserId = null;
        let filteredChips = [];
        let filteredReports = [];
        let filteredMovements = [];

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            updateSectionTitle();
        });

        // Función para hacer requests a Supabase - CORREGIDA PARA MANEJAR RESPUESTAS VACÍAS
        async function supabaseRequest(endpoint, options = {}) {
            const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
            
            const defaultHeaders = {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json'
            };
            
            const config = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            };
            
            try {
                const response = await fetch(url, config);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Supabase error:', errorText);
                    
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(`Error ${response.status}: ${errorJson.message || response.statusText}`);
                    } catch (e) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                }
                
                // Si es una respuesta 204 No Content (DELETE exitoso)
                if (response.status === 204) {
                    return { success: true };
                }
                
                // Si es una respuesta vacía pero exitosa (PATCH/DELETE sin return=representation)
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // Respuesta no es JSON, retornar éxito si el status es 2xx
                    if (response.status >= 200 && response.status < 300) {
                        return { success: true };
                    }
                    return null;
                }
                
                // Intentar parsear como JSON
                try {
                    const data = await response.json();
                    return data;
                } catch (jsonError) {
                    console.warn('No se pudo parsear respuesta como JSON, pero la petición fue exitosa');
                    return { success: true };
                }
                
            } catch (error) {
                console.error('Request failed:', error);
                throw error;
            }
        }

        // Obtener o crear usuario admin
        async function getOrCreateAdminUser() {
            try {
                const users = await supabaseRequest('users?username=eq.admin');
                
                if (users && users.length > 0) {
                    return users[0].id;
                }
                
                console.log('Creando usuario admin...');
                const newUser = await supabaseRequest('users', {
                    method: 'POST',
                    headers: {
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        email: 'admin@sistema.com',
                        nombre: 'Administrador',
                        rol: 'admin'
                    })
                });
                
                if (newUser && newUser[0]) {
                    return newUser[0].id;
                }
                
                return 1;
            } catch (error) {
                console.error('Error obteniendo usuario:', error);
                return 1;
            }
        }

        // Inicializar aplicación
        async function initApp() {
            showLoader();
            try {
                currentUserId = await getOrCreateAdminUser();
                console.log('User ID:', currentUserId);
                
                await loadInitialData();
                showToast('Sistema cargado correctamente', 'success');
            } catch (error) {
                console.error('Error inicializando:', error);
                showToast('Error: ' + error.message, 'error');
                
                loadSampleData();
            } finally {
                hideLoader();
            }
        }

        // Cargar datos iniciales
        async function loadInitialData() {
            try {
                const [cats, chps, reps, movs] = await Promise.all([
                    loadCategories(),
                    loadChips(),
                    loadReports(),
                    loadMovements()
                ]);
                
                categories = cats || [];
                chips = chps || [];
                reports = reps || [];
                movements = movs || [];
                
                // Inicializar arrays filtrados
                filteredChips = [...chips];
                filteredReports = [...reports];
                filteredMovements = [...movements];
                
                updateCategorySelects();
                loadStats();
                updateDashboard();
                displayCategories();
                displayChips();
                displayReports();
                displayMovements();
                
                return true;
            } catch (error) {
                throw error;
            }
        }

        // Datos de ejemplo para pruebas
        function loadSampleData() {
            console.log('Cargando datos de ejemplo...');
            
            categories = [
                { id: 1, nombre: 'Vendedores', created_at: new Date().toISOString() },
                { id: 2, nombre: 'Promotores', created_at: new Date().toISOString() },
                { id: 3, nombre: 'Gerentes', created_at: new Date().toISOString() }
            ];
            
            chips = [
                { 
                    id: 1, 
                    numero: '78765432', 
                    operadora: 'TIGO', 
                    recargas_disponibles: 50,
                    categoria_id: 1,
                    created_at: new Date().toISOString(),
                    cat_v1_categorias: { nombre: 'Vendedores' }
                },
                { 
                    id: 2, 
                    numero: '68712345', 
                    operadora: 'VIVA', 
                    recargas_disponibles: 5,
                    categoria_id: 2,
                    created_at: new Date().toISOString(),
                    cat_v1_categorias: { nombre: 'Promotores' }
                },
                { 
                    id: 3, 
                    numero: '79123456', 
                    operadora: 'ENTEL', 
                    recargas_disponibles: 0,
                    categoria_id: 3,
                    created_at: new Date().toISOString(),
                    cat_v1_categorias: { nombre: 'Gerentes' }
                }
            ];
            
            filteredChips = [...chips];
            
            updateCategorySelects();
            loadStats();
            updateDashboard();
            displayCategories();
            displayChips();
            
            showToast('Modo demo: usando datos de ejemplo', 'warning');
        }

        // Mostrar/Ocultar loader
        function showLoader() {
            document.getElementById('loader').classList.add('active');
        }

        function hideLoader() {
            document.getElementById('loader').classList.remove('active');
        }

        // Mostrar toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Navegación entre secciones
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            
            const button = Array.from(document.querySelectorAll('.nav-item')).find(item => {
                return item.onclick && item.onclick.toString().includes(`'${sectionId}'`);
            });
            if (button) button.classList.add('active');
            
            updateSectionTitle();
        }

        // Actualizar título de sección
        function updateSectionTitle() {
            const activeSection = document.querySelector('.content-section.active');
            const sectionId = activeSection ? activeSection.id : 'dashboard';
            const titles = {
                'dashboard': 'Dashboard',
                'categorias': 'Gestión de Categorías',
                'chips': 'Inventario de Chips',
                'agregar-chip': 'Agregar Nuevo Chip',
                'reportes': 'Reportes de Usuarios',
                'movimientos': 'Historial de Movimientos'
            };
            
            document.getElementById('sectionTitle').textContent = titles[sectionId] || 'Dashboard';
        }

        // Cargar categorías
        async function loadCategories() {
            try {
                const data = await supabaseRequest('cat_v1_categorias?select=*&order=nombre.asc');
                return data || [];
            } catch (error) {
                console.error('Error cargando categorías:', error);
                return [];
            }
        }

        // Mostrar categorías en la tabla
        function displayCategories() {
            const tbody = document.getElementById('categoriesBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (categories.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h3>No hay categorías</h3>
                            <p>Crea tu primera categoría para comenzar</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            categories.forEach(category => {
                const chipsInCategory = chips.filter(chip => chip.categoria_id === category.id);
                const totalRecargas = chipsInCategory.reduce((sum, chip) => sum + chip.recargas_disponibles, 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.id}</td>
                    <td><strong>${category.nombre}</strong></td>
                    <td>${chipsInCategory.length}</td>
                    <td>${totalRecargas}</td>
                    <td>${new Date(category.created_at).toLocaleDateString()}</td>
                    <td class="actions">
                        <button class="action-btn edit" onclick="editCategory(${category.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteCategory(${category.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Actualizar selects de categorías
        function updateCategorySelects() {
            const selects = [
                document.getElementById('filterCategoria'),
                document.getElementById('newChipCategory'),
                document.getElementById('editChipCategory'),
                document.getElementById('bulkCategory')
            ];
            
            selects.forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.nombre;
                    select.appendChild(option);
                });
                
                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            });
        }

        // Abrir modal para agregar categoría
        function openAddCategoryModal() {
            document.getElementById('categoryName').value = '';
            document.getElementById('addCategoryModal').classList.add('active');
        }

        // Cerrar modal de categoría
        function closeAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.remove('active');
        }

        // Guardar nueva categoría
        async function saveCategory() {
            const name = document.getElementById('categoryName').value.trim();
            
            if (!name) {
                showToast('Ingrese un nombre para la categoría', 'error');
                return;
            }
            
            showLoader();
            try {
                if (!currentUserId) {
                    currentUserId = await getOrCreateAdminUser();
                }
                
                const newCategory = await supabaseRequest('cat_v1_categorias', {
                    method: 'POST',
                    headers: {
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        nombre: name,
                        created_by: currentUserId
                    })
                });
                
                if (newCategory && newCategory[0]) {
                    categories.push(newCategory[0]);
                    
                    updateCategorySelects();
                    displayCategories();
                    loadStats();
                    updateDashboard();
                    
                    closeAddCategoryModal();
                    showToast('Categoría creada exitosamente', 'success');
                }
            } catch (error) {
                console.error('Error detallado:', error);
                
                if (error.message.includes('violates foreign key constraint')) {
                    try {
                        console.log('Intentando crear categoría sin created_by...');
                        const newCategory = await supabaseRequest('cat_v1_categorias', {
                            method: 'POST',
                            headers: {
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                nombre: name
                            })
                        });
                        
                        if (newCategory && newCategory[0]) {
                            categories.push(newCategory[0]);
                            updateCategorySelects();
                            displayCategories();
                            loadStats();
                            updateDashboard();
                            closeAddCategoryModal();
                            showToast('Categoría creada exitosamente', 'success');
                        }
                    } catch (secondError) {
                        showToast('Error al crear categoría: ' + secondError.message, 'error');
                    }
                } else {
                    showToast('Error al crear categoría: ' + error.message, 'error');
                }
            } finally {
                hideLoader();
            }
        }

        // Editar categoría
        function editCategory(id) {
            const category = categories.find(c => c.id == id);
            if (!category) return;
            
            const newName = prompt('Editar nombre de categoría:', category.nombre);
            if (newName && newName.trim() !== '' && newName !== category.nombre) {
                supabaseRequest(`cat_v1_categorias?id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        nombre: newName.trim()
                    })
                }).then(() => {
                    category.nombre = newName.trim();
                    displayCategories();
                    updateCategorySelects();
                    showToast('Categoría actualizada', 'success');
                }).catch(error => {
                    showToast('Error al actualizar: ' + error.message, 'error');
                });
            }
        }

        // Cargar chips
        async function loadChips() {
            try {
                const data = await supabaseRequest('cat_v1_chips?select=*,cat_v1_categorias(nombre)&order=created_at.desc');
                return data || [];
            } catch (error) {
                console.error('Error cargando chips:', error);
                return [];
            }
        }

        // Filtrar chips
        function filterChips() {
            const operadora = document.getElementById('filterOperadora').value;
            const categoria = document.getElementById('filterCategoria').value;
            const estado = document.getElementById('filterEstado').value;
            const search = document.getElementById('searchChip').value.toLowerCase();
            
            filteredChips = chips.filter(chip => {
                // Filtro por operadora
                if (operadora && chip.operadora !== operadora) return false;
                
                // Filtro por categoría
                if (categoria && chip.categoria_id != categoria) return false;
                
                // Filtro por estado
                if (estado) {
                    const recargas = chip.recargas_disponibles || 0;
                    switch(estado) {
                        case 'agotado':
                            if (recargas !== 0) return false;
                            break;
                        case 'bajo':
                            if (recargas >= 10 || recargas === 0) return false;
                            break;
                        case 'normal':
                            if (recargas < 10 || recargas > 100) return false;
                            break;
                        case 'alto':
                            if (recargas <= 100) return false;
                            break;
                    }
                }
                
                // Filtro por búsqueda
                if (search && !chip.numero.toLowerCase().includes(search)) return false;
                
                return true;
            });
            
            displayChips();
        }

        // Mostrar chips en la tabla
        function displayChips() {
            const tbody = document.getElementById('chipsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filteredChips.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-sim-card"></i>
                            <h3>No hay chips</h3>
                            <p>${chips.length === 0 ? 'Agrega tu primer chip para comenzar' : 'No hay chips que coincidan con los filtros'}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredChips.forEach(chip => {
                let badgeClass = 'badge-success';
                let badgeText = 'Normal';
                
                if (chip.recargas_disponibles === 0) {
                    badgeClass = 'badge-danger';
                    badgeText = 'Agotado';
                } else if (chip.recargas_disponibles < 10) {
                    badgeClass = 'badge-warning';
                    badgeText = 'Bajo Stock';
                } else if (chip.recargas_disponibles > 100) {
                    badgeClass = 'badge-info';
                    badgeText = 'Alto Stock';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${chip.numero}</strong></td>
                    <td>${chip.operadora}</td>
                    <td>${chip.cat_v1_categorias?.nombre || 'Sin categoría'}</td>
                    <td><strong>${chip.recargas_disponibles}</strong></td>
                    <td><span class="badge ${badgeClass}">${badgeText}</span></td>
                    <td>${new Date(chip.created_at).toLocaleDateString()}</td>
                    <td class="actions">
                        <button class="action-btn edit" onclick="openEditChipModal(${chip.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteChip(${chip.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Guardar nuevo chip
        async function saveNewChip() {
            const numero = document.getElementById('newChipNumber').value.trim();
            const operadora = document.getElementById('newChipOperadora').value;
            const categoria = document.getElementById('newChipCategory').value;
            const recargas = parseInt(document.getElementById('newChipRecargas').value);
            
            if (!numero) {
                showToast('Ingrese el número del chip', 'error');
                return;
            }
            
            if (!/^\d+$/.test(numero)) {
                showToast('El número debe contener solo dígitos', 'error');
                return;
            }
            
            if (!operadora) {
                showToast('Seleccione una operadora', 'error');
                return;
            }
            
            if (!categoria) {
                showToast('Seleccione una categoría', 'error');
                return;
            }
            
            if (isNaN(recargas) || recargas < 0) {
                showToast('Ingrese una cantidad válida de recargas', 'error');
                return;
            }
            
            showLoader();
            try {
                const existingChips = await supabaseRequest(`cat_v1_chips?numero=eq.${numero}`);
                
                if (existingChips && existingChips.length > 0) {
                    throw new Error('El número de chip ya existe');
                }
                
                const chipData = {
                    numero: numero,
                    operadora: operadora,
                    categoria_id: parseInt(categoria),
                    recargas_disponibles: recargas
                };
                
                if (currentUserId) {
                    chipData.created_by = currentUserId;
                }
                
                const newChip = await supabaseRequest('cat_v1_chips', {
                    method: 'POST',
                    headers: {
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(chipData)
                });
                
                if (newChip && newChip[0]) {
                    chips.push(newChip[0]);
                    filteredChips.push(newChip[0]);
                    
                    // Registrar movimiento - CORREGIDO
                    try {
                        const movData = {
                            chip_id: newChip[0].id,
                            tipo_movimiento: 'AGREGAR',
                            cantidad_anterior: 0,
                            cantidad_nueva: recargas
                        };
                        
                        if (currentUserId) {
                            movData.usuario_id = currentUserId;
                        }
                        
                        await supabaseRequest('cat_v1_movimientos', {
                            method: 'POST',
                            headers: {
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify(movData)
                        });
                    } catch (movError) {
                        console.warn('No se pudo registrar el movimiento (esto es normal para respuestas vacías):', movError);
                    }
                    
                    document.getElementById('newChipNumber').value = '';
                    document.getElementById('newChipOperadora').value = '';
                    document.getElementById('newChipCategory').value = '';
                    document.getElementById('newChipRecargas').value = '100';
                    
                    displayChips();
                    loadStats();
                    updateDashboard();
                    
                    showToast('Chip creado exitosamente', 'success');
                    
                    showSection('chips');
                }
            } catch (error) {
                showToast('Error al crear chip: ' + error.message, 'error');
                console.error('Error:', error);
            } finally {
                hideLoader();
            }
        }

        // Abrir modal para editar chip
        function openEditChipModal(chipId) {
            const chip = chips.find(c => c.id == chipId);
            if (!chip) {
                showToast('Chip no encontrado', 'error');
                return;
            }
            
            document.getElementById('editChipId').value = chip.id;
            document.getElementById('editChipNumber').value = chip.numero;
            document.getElementById('editChipOperadora').value = chip.operadora;
            document.getElementById('editChipRecargas').value = chip.recargas_disponibles;
            
            const categorySelect = document.getElementById('editChipCategory');
            categorySelect.innerHTML = '<option value="">Seleccionar Categoría</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.nombre;
                option.selected = cat.id == chip.categoria_id;
                categorySelect.appendChild(option);
            });
            
            document.getElementById('editChipModal').classList.add('active');
        }

        // Cerrar modal de edición
        function closeEditChipModal() {
            document.getElementById('editChipModal').classList.remove('active');
        }

        // Actualizar chip - CORREGIDA PARA MANEJAR RESPUESTAS VACÍAS
        async function updateChip() {
            const chipId = document.getElementById('editChipId').value;
            const nuevasRecargas = parseInt(document.getElementById('editChipRecargas').value);
            const nuevaCategoria = document.getElementById('editChipCategory').value;
            
            if (isNaN(nuevasRecargas) || nuevasRecargas < 0) {
                showToast('Ingrese una cantidad válida de recargas', 'error');
                return;
            }
            
            const chip = chips.find(c => c.id == chipId);
            if (!chip) {
                showToast('Chip no encontrado', 'error');
                return;
            }
            
            showLoader();
            try {
                // Actualizar chip - sin esperar datos de retorno
                await supabaseRequest(`cat_v1_chips?id=eq.${chipId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        recargas_disponibles: nuevasRecargas,
                        categoria_id: parseInt(nuevaCategoria)
                    })
                });
                
                // Actualizar localmente
                const chipIndex = chips.findIndex(c => c.id == chipId);
                if (chipIndex !== -1) {
                    chips[chipIndex].recargas_disponibles = nuevasRecargas;
                    chips[chipIndex].categoria_id = parseInt(nuevaCategoria);
                }
                
                // Registrar movimiento - CORREGIDO
                try {
                    const movData = {
                        chip_id: chipId,
                        tipo_movimiento: 'AGREGAR',
                        cantidad_anterior: chip.recargas_disponibles,
                        cantidad_nueva: nuevasRecargas
                    };
                    
                    if (currentUserId) {
                        movData.usuario_id = currentUserId;
                    }
                    
                    await supabaseRequest('cat_v1_movimientos', {
                        method: 'POST',
                        headers: {
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(movData)
                    });
                } catch (movError) {
                    console.warn('No se pudo registrar el movimiento (esto es normal para respuestas vacías):', movError);
                }
                
                filterChips(); // Actualizar chips filtrados
                loadStats();
                updateDashboard();
                
                closeEditChipModal();
                showToast('Chip actualizado exitosamente', 'success');
            } catch (error) {
                console.error('Error actualizando chip:', error);
                showToast('Error al actualizar chip: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        // Función para desactivar chip en lugar de eliminarlo
        async function deactivateChip(chipId) {
            showLoader();
            try {
                await supabaseRequest(`cat_v1_chips?id=eq.${chipId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        activo: false,
                        eliminado: true,
                        fecha_eliminacion: new Date().toISOString()
                    })
                });
                
                // Actualizar localmente
                const chipIndex = chips.findIndex(c => c.id == chipId);
                if (chipIndex !== -1) {
                    chips[chipIndex].activo = false;
                    chips[chipIndex].eliminado = true;
                }
                
                filterChips();
                loadStats();
                updateDashboard();
                
                showToast('Chip desactivado exitosamente', 'success');
            } catch (error) {
                console.error('Error desactivando chip:', error);
                showToast('Error al desactivar chip: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        // Eliminar chip - CORREGIDA PARA MANEJAR RESPUESTAS VACÍAS
        async function deleteChip(chipId) {
            if (!confirm('¿Está seguro de eliminar este chip? Esta acción no se puede deshacer.')) {
                return;
            }
            
            showLoader();
            try {
                // PRIMERO: Eliminar todos los movimientos relacionados con este chip
                console.log(`Eliminando movimientos relacionados con chip ID: ${chipId}`);
                await supabaseRequest(`cat_v1_movimientos?chip_id=eq.${chipId}`, {
                    method: 'DELETE'
                });
                
                // SEGUNDO: Ahora eliminar el chip
                console.log(`Eliminando chip ID: ${chipId}`);
                await supabaseRequest(`cat_v1_chips?id=eq.${chipId}`, {
                    method: 'DELETE'
                });
                
                // Remover de arrays locales
                chips = chips.filter(c => c.id != chipId);
                filteredChips = filteredChips.filter(c => c.id != chipId);
                
                // También eliminar reportes relacionados (si existen)
                reports = reports.filter(r => r.chip_id != chipId);
                filteredReports = filteredReports.filter(r => r.chip_id != chipId);
                
                displayChips();
                loadStats();
                updateDashboard();
                
                showToast('Chip eliminado exitosamente', 'success');
            } catch (error) {
                console.error('Error eliminando chip:', error);
                
                // Si aún hay error, intentar método alternativo
                if (error.message.includes('409') || error.message.includes('foreign key')) {
                    showToast('No se puede eliminar el chip porque tiene registros relacionados. Intente desactivarlo en lugar de eliminarlo.', 'error');
                    
                    // Alternativa: Marcar el chip como inactivo en lugar de eliminarlo
                    if (confirm('¿Desea marcar este chip como inactivo en lugar de eliminarlo?')) {
                        try {
                            await supabaseRequest(`cat_v1_chips?id=eq.${chipId}`, {
                                method: 'PATCH',
                                body: JSON.stringify({
                                    activo: false,
                                    eliminado: true,
                                    fecha_eliminacion: new Date().toISOString()
                                })
                            });
                            
                            // Actualizar localmente
                            const chipIndex = chips.findIndex(c => c.id == chipId);
                            if (chipIndex !== -1) {
                                chips[chipIndex].activo = false;
                                chips[chipIndex].eliminado = true;
                            }
                            
                            filterChips();
                            loadStats();
                            updateDashboard();
                            
                            showToast('Chip marcado como inactivo', 'success');
                        } catch (patchError) {
                            showToast('Error al marcar el chip como inactivo: ' + patchError.message, 'error');
                        }
                    }
                } else {
                    showToast('Error al eliminar chip: ' + error.message, 'error');
                }
            } finally {
                hideLoader();
            }
        }

        // Cargar reportes
        async function loadReports() {
            try {
                const data = await supabaseRequest('cat_v1_reportes?select=*&order=fecha_reporte.desc');
                return data || [];
            } catch (error) {
                console.error('Error cargando reportes:', error);
                return [];
            }
        }

        // Filtrar reportes
        function filterReports() {
            const fecha = document.getElementById('filterDate').value;
            const search = document.getElementById('searchReport').value.toLowerCase();
            
            filteredReports = reports.filter(reporte => {
                // Filtro por fecha
                if (fecha) {
                    const reportDate = new Date(reporte.fecha_reporte || reporte.created_at).toISOString().split('T')[0];
                    if (reportDate !== fecha) return false;
                }
                
                // Filtro por búsqueda
                if (search) {
                    const usuarioStr = String(reporte.usuario_id || '');
                    const chipStr = String(reporte.chip_id || '');
                    if (!usuarioStr.includes(search) && !chipStr.includes(search)) return false;
                }
                
                return true;
            });
            
            displayReports();
        }

        // Mostrar reportes
        function displayReports() {
            const tbody = document.getElementById('reportsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filteredReports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <h3>No hay reportes</h3>
                            <p>${reports.length === 0 ? 'Los reportes aparecerán aquí' : 'No hay reportes que coincidan con los filtros'}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredReports.forEach(reporte => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${reporte.id}</td>
                    <td>Usuario ${reporte.usuario_id || 'N/A'}</td>
                    <td>${reporte.operadora || 'N/A'}</td>
                    <td><strong>${reporte.cantidad_recargas || 0}</strong></td>
                    <td>Chip ${reporte.chip_id || 'N/A'}</td>
                    <td>Categoría ${reporte.categoria_id || 'N/A'}</td>
                    <td>${new Date(reporte.fecha_reporte || reporte.created_at).toLocaleDateString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Cargar movimientos
        async function loadMovements() {
            try {
                const data = await supabaseRequest('cat_v1_movimientos?select=*&order=created_at.desc');
                return data || [];
            } catch (error) {
                console.error('Error cargando movimientos:', error);
                return [];
            }
        }

        // Filtrar movimientos
        function filterMovements() {
            const tipo = document.getElementById('filterMovimiento').value;
            const search = document.getElementById('searchMovement').value.toLowerCase();
            
            filteredMovements = movements.filter(mov => {
                // Filtro por tipo
                if (tipo && mov.tipo_movimiento !== tipo) return false;
                
                // Filtro por búsqueda
                if (search) {
                    const chipStr = String(mov.chip_id || '');
                    const usuarioStr = String(mov.usuario_id || '');
                    if (!chipStr.includes(search) && !usuarioStr.includes(search)) return false;
                }
                
                return true;
            });
            
            displayMovements();
        }

        // Mostrar movimientos
        function displayMovements() {
            const tbody = document.getElementById('movementsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filteredMovements.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-exchange-alt"></i>
                            <h3>No hay movimientos</h3>
                            <p>${movements.length === 0 ? 'Los movimientos aparecerán aquí' : 'No hay movimientos que coincidan con los filtros'}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredMovements.forEach(mov => {
                const diferencia = mov.cantidad_nueva - mov.cantidad_anterior;
                const diferenciaFormatted = diferencia > 0 ? `+${diferencia}` : diferencia;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(mov.created_at).toLocaleString()}</td>
                    <td>Chip ${mov.chip_id || 'N/A'}</td>
                    <td><span class="badge ${getBadgeClassForType(mov.tipo_movimiento)}">${mov.tipo_movimiento || 'N/A'}</span></td>
                    <td>${mov.cantidad_anterior}</td>
                    <td>${mov.cantidad_nueva}</td>
                    <td><strong>${diferenciaFormatted}</strong></td>
                    <td>Usuario ${mov.usuario_id || 'Sistema'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function getBadgeClassForType(type) {
            if (!type) return 'badge-secondary';
            
            switch(type.toUpperCase()) {
                case 'AGREGAR': return 'badge-success';
                case 'RESTAR': return 'badge-danger';
                case 'REPORTE': return 'badge-info';
                default: return 'badge-secondary';
            }
        }

        // Eliminar categoría - CORREGIDA PARA MANEJAR RESPUESTAS VACÍAS
        async function deleteCategory(categoryId) {
            if (!confirm('¿Está seguro de eliminar esta categoría? Esta acción no se puede deshacer.')) {
                return;
            }
            
            showLoader();
            try {
                // Verificar si hay chips usando esta categoría
                const chipsConCategoria = chips.filter(chip => chip.categoria_id == categoryId);
                
                if (chipsConCategoria.length > 0) {
                    // Preguntar al usuario qué hacer
                    const action = confirm(`Esta categoría tiene ${chipsConCategoria.length} chips asignados. ¿Desea reasignarlos a otra categoría antes de eliminar?`);
                    
                    if (action) {
                        // Buscar otra categoría disponible
                        const otraCategoria = categories.find(c => c.id != categoryId);
                        
                        if (otraCategoria) {
                            // Reasignar todos los chips a la otra categoría
                            for (const chip of chipsConCategoria) {
                                await supabaseRequest(`cat_v1_chips?id=eq.${chip.id}`, {
                                    method: 'PATCH',
                                    body: JSON.stringify({
                                        categoria_id: otraCategoria.id
                                    })
                                });
                            }
                            
                            // Actualizar chips localmente
                            chips.forEach(chip => {
                                if (chip.categoria_id == categoryId) {
                                    chip.categoria_id = otraCategoria.id;
                                    chip.cat_v1_categorias = { nombre: otraCategoria.nombre };
                                }
                            });
                            
                            filteredChips = [...chips];
                        } else {
                            // Si no hay otra categoría, no se puede eliminar
                            showToast('No hay otra categoría disponible para reasignar los chips', 'error');
                            hideLoader();
                            return;
                        }
                    } else {
                        // Si el usuario no quiere reasignar, no se puede eliminar
                        showToast('No se puede eliminar una categoría con chips asignados', 'error');
                        hideLoader();
                        return;
                    }
                }
                
                // Ahora eliminar la categoría
                await supabaseRequest(`cat_v1_categorias?id=eq.${categoryId}`, {
                    method: 'DELETE'
                });
                
                // Remover de arrays locales
                categories = categories.filter(c => c.id != categoryId);
                
                updateCategorySelects();
                displayCategories();
                displayChips();
                loadStats();
                updateDashboard();
                
                showToast('Categoría eliminada exitosamente', 'success');
            } catch (error) {
                console.error('Error eliminando categoría:', error);
                
                if (error.message.includes('409') || error.message.includes('foreign key')) {
                    showToast('No se puede eliminar la categoría porque tiene chips asignados. Reasigne los chips primero.', 'error');
                } else {
                    showToast('Error al eliminar categoría: ' + error.message, 'error');
                }
            } finally {
                hideLoader();
            }
        }

        // Cargar estadísticas
        function loadStats() {
            try {
                document.getElementById('statsCategories').textContent = categories.length;
                
                // Contar solo chips activos (no eliminados)
                const chipsActivos = chips.filter(chip => !chip.eliminado);
                document.getElementById('statsChips').textContent = chipsActivos.length;
                
                const totalRecargas = chipsActivos.reduce((sum, chip) => sum + (chip.recargas_disponibles || 0), 0);
                document.getElementById('statsRecargas').textContent = totalRecargas;
                
                const hoy = new Date().toISOString().split('T')[0];
                const reportsHoy = reports.filter(r => {
                    const fecha = r.fecha_reporte || r.created_at;
                    return fecha && fecha.toString().startsWith(hoy);
                }).length;
                document.getElementById('statsReportes').textContent = reportsHoy;
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        // Actualizar dashboard
        function updateDashboard() {
            const summaryDiv = document.getElementById('dashboardSummary');
            if (!summaryDiv) return;
            
            // Contar solo chips activos
            const chipsActivos = chips.filter(chip => !chip.eliminado);
            const totalChips = chipsActivos.length;
            const totalRecargas = chipsActivos.reduce((sum, chip) => sum + (chip.recargas_disponibles || 0), 0);
            const chipsAgotados = chipsActivos.filter(c => (c.recargas_disponibles || 0) === 0).length;
            const chipsBajoStock = chipsActivos.filter(c => (c.recargas_disponibles || 0) > 0 && (c.recargas_disponibles || 0) < 10).length;
            
            summaryDiv.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <h4 style="color: var(--gray); margin-bottom: 8px; font-size: 13px; font-weight: 500;">Resumen General</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: var(--light); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--gray);">Chips Activos</div>
                                <div style="font-size: 20px; font-weight: 700;">${totalChips}</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: var(--light); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--gray);">Recargas Totales</div>
                                <div style="font-size: 20px; font-weight: 700;">${totalRecargas}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="color: var(--gray); margin-bottom: 8px; font-size: 13px; font-weight: 500;">Estado del Inventario</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.2); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--danger);">Chips Agotados</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--danger);">${chipsAgotados}</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: rgba(255, 149, 0, 0.1); border: 1px solid rgba(255, 149, 0, 0.2); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--warning);">Chips Bajo Stock</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--warning);">${chipsBajoStock}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="color: var(--gray); margin-bottom: 8px; font-size: 13px; font-weight: 500;">Distribución por Operadora</h4>
                        <div style="display: flex; gap: 8px;">
                            <span style="font-size: 12px; padding: 4px 8px; background: rgba(0, 122, 255, 0.1); border-radius: 6px; color: var(--primary);">
                                TIGO: ${chipsActivos.filter(c => c.operadora === 'TIGO').length}
                            </span>
                            <span style="font-size: 12px; padding: 4px 8px; background: rgba(255, 149, 0, 0.1); border-radius: 6px; color: var(--warning);">
                                VIVA: ${chipsActivos.filter(c => c.operadora === 'VIVA').length}
                            </span>
                            <span style="font-size: 12px; padding: 4px 8px; background: rgba(52, 199, 89, 0.1); border-radius: 6px; color: var(--success);">
                                ENTEL: ${chipsActivos.filter(c => c.operadora === 'ENTEL').length}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            const lowStockTable = document.querySelector('#lowStockTable tbody');
            if (lowStockTable) {
                lowStockTable.innerHTML = '';
                
                const lowStockChips = chipsActivos.filter(c => (c.recargas_disponibles || 0) < 10 && (c.recargas_disponibles || 0) > 0)
                    .sort((a, b) => (a.recargas_disponibles || 0) - (b.recargas_disponibles || 0));
                
                if (lowStockChips.length === 0) {
                    lowStockTable.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--gray); padding: 40px;">
                                <i class="fas fa-check-circle"></i> No hay chips con bajo stock
                            </td>
                        </tr>
                    `;
                } else {
                    lowStockChips.slice(0, 10).forEach(chip => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${chip.numero}</strong></td>
                            <td>${chip.operadora}</td>
                            <td>${chip.cat_v1_categorias?.nombre || 'Sin categoría'}</td>
                            <td><strong style="color: var(--warning);">${chip.recargas_disponibles}</strong></td>
                            <td><span class="badge badge-warning">Bajo Stock</span></td>
                        `;
                        lowStockTable.appendChild(row);
                    });
                }
            }
        }

        // Refrescar datos
        async function refreshData() {
            showLoader();
            try {
                await loadInitialData();
                showToast('Datos actualizados correctamente', 'success');
            } catch (error) {
                showToast('Error al actualizar datos', 'error');
            } finally {
                hideLoader();
            }
        }

        // Filtrar categorías
        function filterCategories() {
            const search = document.getElementById('searchCategory').value.toLowerCase();
            const rows = document.querySelectorAll('#categoriesBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // FUNCIONALIDAD DE CARGA MASIVA
        function openBulkChipsModal() {
            document.getElementById('bulkCategory').value = '';
            document.getElementById('bulkOperadora').value = '';
            document.getElementById('bulkRecargas').value = '100';
            document.getElementById('bulkChipNumbers').value = '';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0% completado';
            
            document.getElementById('bulkChipsModal').classList.add('active');
        }

        function closeBulkChipsModal() {
            document.getElementById('bulkChipsModal').classList.remove('active');
        }

        // Procesar carga masiva - CORREGIDA PARA MANEJAR RESPUESTAS VACÍAS
        async function processBulkUpload() {
            const categoriaId = document.getElementById('bulkCategory').value;
            const operadora = document.getElementById('bulkOperadora').value;
            const recargas = parseInt(document.getElementById('bulkRecargas').value);
            const input = document.getElementById('bulkChipNumbers').value.trim();
            
            if (!categoriaId) {
                showToast('Seleccione una categoría', 'error');
                return;
            }
            
            if (!operadora) {
                showToast('Seleccione una operadora', 'error');
                return;
            }
            
            if (isNaN(recargas) || recargas < 0) {
                showToast('Ingrese una cantidad válida de recargas', 'error');
                return;
            }
            
            if (!input) {
                showToast('Ingrese números de chip', 'error');
                return;
            }
            
            // Separar y validar números
            let numbers = input.split(/[\n, ]+/).map(num => num.trim()).filter(num => num !== '');
            const validNumbers = numbers.filter(num => /^\d+$/.test(num));
            
            if (validNumbers.length === 0) {
                showToast('No hay números válidos para crear', 'error');
                return;
            }
            
            if (validNumbers.length > 1000) {
                if (!confirm(`¿Está seguro de crear ${validNumbers.length} chips? Esta operación puede tomar varios minutos.`)) {
                    return;
                }
            }
            
            showLoader();
            
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            let successCount = 0;
            let errorCount = 0;
            
            // Procesar en lotes
            const batchSize = 10;
            const totalChips = validNumbers.length;
            
            for (let i = 0; i < totalChips; i += batchSize) {
                const batch = validNumbers.slice(i, i + batchSize);
                
                for (let j = 0; j < batch.length; j++) {
                    const chipNumber = batch[j];
                    const currentIndex = i + j + 1;
                    
                    try {
                        // Verificar si el chip ya existe
                        const existingChips = await supabaseRequest(`cat_v1_chips?numero=eq.${chipNumber}`);
                        
                        if (existingChips && existingChips.length > 0) {
                            errorCount++;
                            continue;
                        }
                        
                        // Crear chip
                        const chipData = {
                            numero: chipNumber,
                            operadora: operadora,
                            categoria_id: parseInt(categoriaId),
                            recargas_disponibles: recargas
                        };
                        
                        if (currentUserId) {
                            chipData.created_by = currentUserId;
                        }
                        
                        const newChip = await supabaseRequest('cat_v1_chips', {
                            method: 'POST',
                            headers: {
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify(chipData)
                        });
                        
                        if (newChip && newChip[0]) {
                            chips.push(newChip[0]);
                            filteredChips.push(newChip[0]);
                            successCount++;
                            
                            // Registrar movimiento - CORREGIDO
                            try {
                                const movData = {
                                    chip_id: newChip[0].id,
                                    tipo_movimiento: 'AGREGAR',
                                    cantidad_anterior: 0,
                                    cantidad_nueva: recargas
                                };
                                
                                if (currentUserId) {
                                    movData.usuario_id = currentUserId;
                                }
                                
                                await supabaseRequest('cat_v1_movimientos', {
                                    method: 'POST',
                                    headers: {
                                        'Prefer': 'return=representation'
                                    },
                                    body: JSON.stringify(movData)
                                });
                            } catch (movError) {
                                console.warn('No se pudo registrar movimiento (esto es normal para respuestas vacías):', movError);
                            }
                        }
                    } catch (error) {
                        console.error('Error creando chip:', error);
                        errorCount++;
                    }
                    
                    // Actualizar progreso
                    const progress = Math.round((currentIndex / totalChips) * 100);
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `${progress}% completado (${currentIndex}/${totalChips})`;
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Actualizar UI
            displayChips();
            loadStats();
            updateDashboard();
            
            // Restaurar botón
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Crear Chips';
            
            hideLoader();
            
            // Mostrar resultados
            let message = `Creación completada: ${successCount} chips creados exitosamente`;
            if (errorCount > 0) {
                message += `, ${errorCount} errores`;
            }
            
            showToast(message, errorCount > 0 ? 'warning' : 'success');
            
            if (errorCount === 0) {
                closeBulkChipsModal();
            }
        }

        // Cerrar sesión
        function logout() {
            if (confirm('¿Está seguro de cerrar sesión?')) {
                window.location.href = 'login.html';
            }
        }

        // Configurar auto-refresh cada 30 segundos
        setInterval(refreshData, 30000);

        // Configurar eventos para carga masiva
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('bulkChipNumbers');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    const lines = this.value.trim().split(/[\n, ]+/).filter(l => l).length;
                    if (lines > 0) {
                        document.getElementById('progressText').textContent = `${lines} chips listos para crear`;
                    }
                });
            }
        });
    </script>
</body>
</html>