<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOKTOK ¬∑ Admin Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tok: {
                            green: '#10b981',
                            blue: '#3b82f6',
                            red: '#ef4444',
                            yellow: '#f59e0b',
                            purple: '#8b5cf6'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --tok-green: #10b981;
            --tok-blue: #3b82f6;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-connected { background: #d1fae5; color: #065f46; }
        .status-disconnected { background: #fee2e2; color: #991b1b; }
        .status-pending { background: #fef3c7; color: #92400e; }
        
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .id-card {
            width: 85.6mm;
            height: 54mm;
            border-radius: 8mm;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .qr-overlay {
            position: absolute;
            bottom: 8mm;
            right: 8mm;
            width: 25mm;
            height: 25mm;
            background: white;
            padding: 2mm;
            border-radius: 3mm;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--tok-green);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-success { background: var(--tok-green); }
        .toast-error { background: var(--tok-red); }
        .toast-info { background: var(--tok-blue); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>
    
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <div class="bg-tok-green text-white p-2 rounded-lg font-bold text-xl">
                            TOK
                        </div>
                        <span class="ml-2 text-xl font-bold text-gray-800">TOKTOK Dashboard</span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="connection-status" class="status-badge status-pending">
                        <span class="flex items-center">
                            <span class="animate-pulse">‚óè</span>
                            <span class="ml-2">Conectando...</span>
                        </span>
                    </div>
                    <button onclick="testConnection()" class="px-3 py-1 bg-gray-100 rounded-lg text-sm hover:bg-gray-200">
                        Probar Conexi√≥n
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card p-6">
                <div class="flex items-center">
                    <div class="bg-tok-green bg-opacity-10 p-3 rounded-lg">
                        <span class="text-tok-green text-2xl">üë•</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Trabajadores</h3>
                        <p id="stats-workers" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <div class="flex items-center">
                    <div class="bg-tok-blue bg-opacity-10 p-3 rounded-lg">
                        <span class="text-tok-blue text-2xl">üìä</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Asistencias Hoy</h3>
                        <p id="stats-today" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <div class="flex items-center">
                    <div class="bg-tok-yellow bg-opacity-10 p-3 rounded-lg">
                        <span class="text-tok-yellow text-2xl">‚è±Ô∏è</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Horas Extras</h3>
                        <p id="stats-extras" class="text-2xl font-bold text-gray-800">0h</p>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <div class="flex items-center">
                    <div class="bg-tok-purple bg-opacity-10 p-3 rounded-lg">
                        <span class="text-tok-purple text-2xl">üìà</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">Prom. Diario</h3>
                        <p id="stats-avg" class="text-2xl font-bold text-gray-800">0h</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabs Navigation -->
        <div class="mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button data-tab="workers" class="tab-button py-4 px-1 border-b-2 font-medium text-sm border-tok-green text-tok-green">
                        üë§ Trabajadores
                    </button>
                    <button data-tab="reports" class="tab-button py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        üìä Reportes
                    </button>
                    <button data-tab="cards" class="tab-button py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        üè∑Ô∏è Credenciales
                    </button>
                </nav>
            </div>
        </div>
        
        <!-- Tab Content: Workers -->
        <div id="tab-workers" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Formulario Registro -->
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Registrar Nuevo Trabajador</h2>
                    
                    <form id="worker-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombres *</label>
                                <input type="text" id="input-nombres" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tok-green focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Apellidos *</label>
                                <input type="text" id="input-apellidos" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tok-green focus:border-transparent">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">C√©dula *</label>
                                <input type="text" id="input-ci" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tok-green focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cargo *</label>
                                <input type="text" id="input-cargo" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-tok-green focus:border-transparent">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Foto (opcional)</label>
                            <input type="file" id="input-foto" accept="image/*"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        
                        <div class="pt-4">
                            <button type="submit" 
                                    class="w-full bg-tok-green text-white py-3 px-4 rounded-lg font-medium hover:bg-emerald-600 transition-colors">
                                üíæ Guardar Trabajador
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Lista de Trabajadores -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Lista de Trabajadores</h2>
                        <button onclick="loadWorkers()" class="px-4 py-2 bg-gray-100 rounded-lg text-sm hover:bg-gray-200">
                            üîÑ Actualizar
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CI</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cargo</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="workers-list" class="divide-y divide-gray-200">
                                <!-- Datos cargados aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Content: Reports -->
        <div id="tab-reports" class="tab-content hidden">
            <div class="card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Reportes de Asistencia</h2>
                
                <!-- Filtros -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <input type="date" id="filter-fecha" class="px-3 py-2 border rounded-lg">
                    <select id="filter-trabajador" class="px-3 py-2 border rounded-lg">
                        <option value="">Todos los trabajadores</option>
                    </select>
                    <select id="filter-evento" class="px-3 py-2 border rounded-lg">
                        <option value="">Todos los eventos</option>
                        <option value="entrada">Entrada</option>
                        <option value="salida">Salida</option>
                        <option value="extra">Horas Extra</option>
                    </select>
                    <button onclick="loadReports()" class="bg-tok-blue text-white py-2 px-4 rounded-lg hover:bg-blue-600">
                        üîç Filtrar
                    </button>
                </div>
                
                <!-- Tabla de Reportes -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trabajador</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Evento</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hora</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Horas</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notas</th>
                            </tr>
                        </thead>
                        <tbody id="reports-list" class="divide-y divide-gray-200">
                            <!-- Datos cargados aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Exportar -->
                <div class="mt-6 flex justify-end">
                    <button onclick="exportToPDF()" class="px-4 py-2 bg-tok-green text-white rounded-lg hover:bg-emerald-600">
                        üìÑ Exportar PDF
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tab Content: Cards -->
        <div id="tab-cards" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Generador de Credencial -->
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Generar Credencial</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Trabajador</label>
                            <select id="select-worker" class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    onchange="loadWorkerForCard(this.value)">
                                <option value="">Seleccione un trabajador</option>
                            </select>
                        </div>
                        
                        <div id="card-preview" class="hidden">
                            <div class="flex justify-center mb-6">
                                <div class="id-card">
                                    <div class="absolute top-4 left-4 text-white font-bold">TOKTOK</div>
                                    <div class="h-full flex">
                                        <div class="w-1/3 bg-gray-200 flex items-center justify-center">
                                            <img id="card-photo" class="w-full h-full object-cover">
                                        </div>
                                        <div class="w-2/3 p-4 flex flex-col justify-between">
                                            <div class="text-white">
                                                <div class="mb-2">
                                                    <div class="text-xs opacity-80">Nombre:</div>
                                                    <div id="card-name" class="font-bold"></div>
                                                </div>
                                                <div class="mb-2">
                                                    <div class="text-xs opacity-80">CI:</div>
                                                    <div id="card-ci" class="font-mono"></div>
                                                </div>
                                                <div>
                                                    <div class="text-xs opacity-80">Cargo:</div>
                                                    <div id="card-cargo"></div>
                                                </div>
                                            </div>
                                            <div class="qr-overlay" id="qr-container"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="printCard()" class="py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800">
                                    üñ®Ô∏è Imprimir
                                </button>
                                <button onclick="downloadCard()" class="py-3 bg-tok-blue text-white rounded-lg hover:bg-blue-600">
                                    üì• Descargar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de Credenciales -->
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Credenciales Generadas</h2>
                    <div id="cards-list" class="space-y-4">
                        <!-- Lista cargada aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://gqmkhqrsfnmrlunagjsx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_cAAL7KuzDhu2zzsZeF7oLg__awJFxHQ';
        
        let supabase = null;
        let currentWorkerData = null;
        let qrCodeInstance = null;
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeApp();
            setupEventListeners();
            setupTabs();
        });
        
        async function initializeApp() {
            showToast('üîå Conectando con Supabase...', 'info');
            updateConnectionStatus('connecting');
            
            try {
                // Inicializar Supabase
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: { persistSession: false }
                });
                
                // Verificar conexi√≥n
                const { data, error } = await supabase
                    .from('workers')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw new Error(`Error de conexi√≥n: ${error.message}`);
                }
                
                // Conexi√≥n exitosa
                updateConnectionStatus('connected');
                showToast('‚úÖ Conectado a Supabase exitosamente!', 'success');
                
                // Cargar datos iniciales
                await loadInitialData();
                
            } catch (error) {
                console.error('Error de inicializaci√≥n:', error);
                updateConnectionStatus('error');
                showToast(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function loadInitialData() {
            try {
                await Promise.all([
                    loadWorkers(),
                    loadStats(),
                    loadReports()
                ]);
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }
        
        // ============================================
        // FUNCIONES DE CONEXI√ìN
        // ============================================
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = 'status-badge ';
            
            switch(status) {
                case 'connected':
                    statusEl.classList.add('status-connected');
                    statusEl.innerHTML = '<span class="flex items-center"><span class="text-green-500">‚óè</span><span class="ml-2">Conectado</span></span>';
                    break;
                case 'connecting':
                    statusEl.classList.add('status-pending');
                    statusEl.innerHTML = '<span class="flex items-center"><span class="animate-pulse">‚óè</span><span class="ml-2">Conectando...</span></span>';
                    break;
                case 'error':
                    statusEl.classList.add('status-disconnected');
                    statusEl.innerHTML = '<span class="flex items-center"><span class="text-red-500">‚óè</span><span class="ml-2">Error</span></span>';
                    break;
            }
        }
        
        async function testConnection() {
            showToast('üîç Probando conexi√≥n...', 'info');
            
            try {
                const { data, error } = await supabase
                    .from('workers')
                    .select('*')
                    .limit(1);
                
                if (error) throw error;
                
                showToast('‚úÖ Conexi√≥n exitosa!', 'success');
                return true;
            } catch (error) {
                showToast(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                return false;
            }
        }
        
        // ============================================
        // FUNCIONES DE TRABAJADORES
        // ============================================
        async function loadWorkers() {
            try {
                const { data, error } = await supabase
                    .from('workers')
                    .select('*')
                    .order('nombres');
                
                if (error) throw error;
                
                // Actualizar lista
                const tbody = document.getElementById('workers-list');
                const select = document.getElementById('select-worker');
                const filterSelect = document.getElementById('filter-trabajador');
                
                tbody.innerHTML = '';
                select.innerHTML = '<option value="">Seleccione un trabajador</option>';
                filterSelect.innerHTML = '<option value="">Todos los trabajadores</option>';
                
                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                No hay trabajadores registrados
                            </td>
                        </tr>`;
                    return;
                }
                
                data.forEach(worker => {
                    // Tabla
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-3">${worker.nombres} ${worker.apellidos}</td>
                        <td class="px-4 py-3 font-mono">${worker.ci}</td>
                        <td class="px-4 py-3">${worker.cargo}</td>
                        <td class="px-4 py-3">
                            <button onclick="deleteWorker('${worker.id}')" 
                                    class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200">
                                Eliminar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                    
                    // Selectores
                    const option = `<option value="${worker.id}">${worker.nombres} ${worker.apellidos} - ${worker.ci}</option>`;
                    select.innerHTML += option;
                    filterSelect.innerHTML += option;
                });
                
            } catch (error) {
                console.error('Error cargando trabajadores:', error);
                showToast('‚ùå Error al cargar trabajadores', 'error');
            }
        }
        
        async function deleteWorker(id) {
            if (!confirm('¬øEst√° seguro de eliminar este trabajador?')) return;
            
            try {
                const { error } = await supabase
                    .from('workers')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showToast('‚úÖ Trabajador eliminado', 'success');
                await loadWorkers();
                await loadStats();
                
            } catch (error) {
                console.error('Error eliminando trabajador:', error);
                showToast('‚ùå Error al eliminar trabajador', 'error');
            }
        }
        
        // ============================================
        // FORMULARIO DE TRABAJADOR
        // ============================================
        document.getElementById('worker-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nombres = document.getElementById('input-nombres').value.trim();
            const apellidos = document.getElementById('input-apellidos').value.trim();
            const ci = document.getElementById('input-ci').value.trim();
            const cargo = document.getElementById('input-cargo').value.trim();
            const fotoFile = document.getElementById('input-foto').files[0];
            
            if (!nombres || !apellidos || !ci || !cargo) {
                showToast('‚ùå Complete todos los campos obligatorios', 'error');
                return;
            }
            
            try {
                showToast('üîÑ Guardando trabajador...', 'info');
                
                // Subir foto si existe
                let fotoUrl = null;
                if (fotoFile) {
                    const fileExt = fotoFile.name.split('.').pop();
                    const fileName = `${ci}_${Date.now()}.${fileExt}`;
                    const filePath = `fotos/${fileName}`;
                    
                    const { error: uploadError } = await supabase.storage
                        .from('fotos_trabajadores')
                        .upload(filePath, fotoFile);
                    
                    if (!uploadError) {
                        const { data: urlData } = supabase.storage
                            .from('fotos_trabajadores')
                            .getPublicUrl(filePath);
                        fotoUrl = urlData.publicUrl;
                    }
                }
                
                // Generar QR √∫nico
                const qrId = `TOK-${ci}-${Date.now().toString(36)}`;
                
                // Insertar en base de datos
                const { error } = await supabase
                    .from('workers')
                    .insert([{
                        nombres,
                        apellidos,
                        ci,
                        cargo,
                        foto_url: fotoUrl,
                        qr_id: qrId
                    }]);
                
                if (error) {
                    if (error.code === '23505') {
                        throw new Error('Ya existe un trabajador con esa c√©dula');
                    }
                    throw error;
                }
                
                // √âxito
                showToast('‚úÖ Trabajador registrado exitosamente!', 'success');
                
                // Limpiar formulario
                this.reset();
                
                // Actualizar datos
                await Promise.all([
                    loadWorkers(),
                    loadStats()
                ]);
                
            } catch (error) {
                console.error('Error guardando trabajador:', error);
                showToast(`‚ùå Error: ${error.message}`, 'error');
            }
        });
        
        // ============================================
        // FUNCIONES DE CREDENCIALES
        // ============================================
        async function loadWorkerForCard(workerId) {
            if (!workerId) {
                document.getElementById('card-preview').classList.add('hidden');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('workers')
                    .select('*')
                    .eq('id', workerId)
                    .single();
                
                if (error) throw error;
                
                currentWorkerData = data;
                
                // Actualizar vista
                document.getElementById('card-name').textContent = `${data.nombres} ${data.apellidos}`;
                document.getElementById('card-ci').textContent = data.ci;
                document.getElementById('card-cargo').textContent = data.cargo;
                document.getElementById('card-photo').src = data.foto_url || 'https://placehold.co/100x100?text=Foto';
                
                // Generar QR
                const qrContainer = document.getElementById('qr-container');
                qrContainer.innerHTML = '';
                
                if (qrCodeInstance) {
                    qrCodeInstance.clear();
                }
                
                qrCodeInstance = new QRCode(qrContainer, {
                    text: data.qr_id,
                    width: 80,
                    height: 80,
                    colorDark: "#000000",
                    colorLight: "#ffffff"
                });
                
                document.getElementById('card-preview').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error cargando trabajador:', error);
                showToast('‚ùå Error al cargar datos del trabajador', 'error');
            }
        }
        
        function printCard() {
            if (!currentWorkerData) {
                showToast('‚ùå Seleccione un trabajador primero', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Credencial TOKTOK - ${currentWorkerData.nombres}</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                display: flex; 
                                justify-content: center; 
                                align-items: center; 
                                min-height: 100vh; 
                            }
                            @media print {
                                .id-card { 
                                    box-shadow: none !important; 
                                    border: 1px solid #ccc; 
                                }
                            }
                        </style>
                    </head>
                    <body>
                        ${document.getElementById('card-preview').innerHTML}
                        <script>
                            window.onload = () => window.print();
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        function downloadCard() {
            showToast('‚ö† Funci√≥n en desarrollo', 'info');
            // Implementar descarga de imagen
        }
        
        // ============================================
        // FUNCIONES DE REPORTES
        // ============================================
        async function loadReports() {
            try {
                const fecha = document.getElementById('filter-fecha').value;
                const trabajadorId = document.getElementById('filter-trabajador').value;
                const evento = document.getElementById('filter-evento').value;
                
                let query = supabase
                    .from('attendance')
                    .select(`
                        *,
                        workers (nombres, apellidos, ci, cargo)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (fecha) {
                    const startDate = fecha + 'T00:00:00';
                    const endDate = fecha + 'T23:59:59';
                    query = query.gte('created_at', startDate).lte('created_at', endDate);
                }
                
                if (trabajadorId) {
                    query = query.eq('worker_id', trabajadorId);
                }
                
                if (evento) {
                    query = query.eq('event_type', evento);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                const tbody = document.getElementById('reports-list');
                tbody.innerHTML = '';
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                No hay registros para mostrar
                            </td>
                        </tr>`;
                    return;
                }
                
                data.forEach(record => {
                    const worker = record.workers || {};
                    const date = new Date(record.created_at);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-3">${date.toLocaleDateString('es-ES')}</td>
                        <td class="px-4 py-3">${worker.nombres || ''} ${worker.apellidos || ''}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs ${
                                record.event_type === 'entrada' ? 'bg-green-100 text-green-800' :
                                record.event_type === 'salida' ? 'bg-blue-100 text-blue-800' :
                                'bg-yellow-100 text-yellow-800'
                            }">
                                ${record.event_type}
                            </span>
                        </td>
                        <td class="px-4 py-3">${date.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</td>
                        <td class="px-4 py-3">${record.horas_trabajadas || '0'}h</td>
                        <td class="px-4 py-3 max-w-xs truncate">${record.notes || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Error cargando reportes:', error);
                showToast('‚ùå Error al cargar reportes', 'error');
            }
        }
        
        async function loadStats() {
            try {
                // Total trabajadores
                const { count: totalWorkers } = await supabase
                    .from('workers')
                    .select('*', { count: 'exact', head: true });
                
                document.getElementById('stats-workers').textContent = totalWorkers || 0;
                
                // Asistencias hoy
                const today = new Date().toISOString().split('T')[0];
                const { count: todayAttendances } = await supabase
                    .from('attendance')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today + 'T00:00:00')
                    .lte('created_at', today + 'T23:59:59');
                
                document.getElementById('stats-today').textContent = todayAttendances || 0;
                
                // Horas extras
                const { data: extrasData } = await supabase
                    .from('attendance')
                    .select('horas_extras')
                    .gte('created_at', today + 'T00:00:00')
                    .lte('created_at', today + 'T23:59:59');
                
                const totalExtras = extrasData?.reduce((sum, item) => sum + (item.horas_extras || 0), 0) || 0;
                document.getElementById('stats-extras').textContent = `${totalExtras.toFixed(1)}h`;
                
                // Promedio diario
                const { data: weeklyData } = await supabase
                    .from('attendance')
                    .select('horas_trabajadas, created_at')
                    .gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());
                
                const avgHours = weeklyData?.reduce((sum, item) => sum + (item.horas_trabajadas || 0), 0) / 7 || 0;
                document.getElementById('stats-avg').textContent = `${avgHours.toFixed(1)}h`;
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }
        
        function exportToPDF() {
            showToast('‚ö† Funci√≥n PDF en desarrollo', 'info');
        }
        
        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type}`;
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }
        
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    
                    // Actualizar botones
                    tabButtons.forEach(btn => {
                        btn.classList.remove('border-tok-green', 'text-tok-green');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    button.classList.remove('border-transparent', 'text-gray-500');
                    button.classList.add('border-tok-green', 'text-tok-green');
                    
                    // Mostrar contenido
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    document.getElementById(`tab-${tabId}`).classList.remove('hidden');
                });
            });
        }
        
        function setupEventListeners() {
            // Test connection button
            window.testConnection = testConnection;
            
            // Reload workers
            window.loadWorkers = loadWorkers;
            
            // Load reports
            window.loadReports = loadReports;
            
            // Export PDF
            window.exportToPDF = exportToPDF;
            
            // Print card
            window.printCard = printCard;
            
            // Download card
            window.downloadCard = downloadCard;
            
            // Delete worker
            window.deleteWorker = deleteWorker;
        }
    </script>
</body>
</html>
